name: Deploy Our Space

# Trigger deployment on push to main branch or manual trigger
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

# Required permissions for deployment
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # Checkout repository
      - name: Checkout code
        uses: actions/checkout@v3
      
      # Create config.js with secrets
      # Note: OSW_REPO and OSW_TOKEN must be set in repository secrets
      # Settings -> Secrets and variables -> Actions -> New repository secret
      - name: Create config.js from secrets
        run: |
          cat > config.js << 'EOF'
          // Our Space - Auto-generated Configuration
          // DO NOT edit this file manually - it's generated from repository secrets
          
          window.SERVER_CONFIG = {
              githubRepo: '${{ secrets.OSW_REPO }}',
              githubToken: '${{ secrets.OSW_TOKEN }}'
          };
          
          // Configuration loaded from secrets:
          // - OSW_REPO: GitHub repository (username/repo-name)
          // - OSW_TOKEN: Personal Access Token with repo permissions
          EOF
      
      # Verify config was created
      - name: Verify config.js
        run: |
          echo "Config file created:"
          ls -la config.js
          echo "File size: $(wc -c < config.js) bytes"
      
      # Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          cname: ${{ secrets.CUSTOM_DOMAIN }}  # Optional: set CUSTOM_DOMAIN secret if using custom domain
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy Our Space to GitHub Pages'

# SETUP INSTRUCTIONS:
# 
# 1. Save this file as: .github/workflows/deploy.yml
# 
# 2. Set up repository secrets (Settings -> Secrets and variables -> Actions):
#    - OSW_REPO: your-username/your-repo-name
#    - OSW_TOKEN: your Personal Access Token (from github.com/settings/tokens)
#    - CUSTOM_DOMAIN: (optional) your custom domain if using one
# 
# 3. Commit and push this workflow file to your repository
# 
# 4. Enable GitHub Pages:
#    Settings -> Pages -> Source: Deploy from a branch
#    Branch: gh-pages (will be created by this workflow)
# 
# 5. The workflow will automatically run on every push to main/master branch
# 
# 6. You can also manually trigger it:
#    Actions tab -> "Deploy Our Space" workflow -> Run workflow
# 
# IMPORTANT NOTES:
# - Never use secrets starting with GITHUB_ (reserved by GitHub)
# - OSW stands for "Our Space Web"
# - The GITHUB_TOKEN secret is automatically provided by GitHub
# - Your app will be available at: https://username.github.io/repo-name/
# 
# SECURITY:
# - config.js is generated during deployment (never committed to repo)
# - Secrets are encrypted and only visible to workflow
# - Token is never exposed in logs or repository history
