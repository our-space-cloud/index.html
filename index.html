<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Space</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-pink: #f8d7da;
            --secondary-lavender: #e7d3f4;
            --soft-peach: #ffeaa7;
            --mint-green: #d1f2eb;
            --soft-blue: #d4f1f4;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --white: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
            --error: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: linear-gradient(135deg, var(--primary-pink), var(--soft-blue));
            min-height: 100vh;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--text-light);
            border-top: 5px solid var(--primary-pink);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .help-button, .notification-button {
            position: fixed;
            top: 20px;
            width: 50px;
            height: 50px;
            background: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 20px var(--shadow);
            z-index: 1001;
            transition: all 0.3s ease;
        }

        .help-button {
            right: 20px;
        }

        .notification-button {
            right: 80px;
            display: none;
        }

        .notification-button.active {
            display: flex;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--error);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .help-button:hover, .notification-button:hover {
            transform: scale(1.1);
            background: var(--soft-peach);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 2rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: 25px;
            padding: 3rem;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .tutorial-step {
            display: none;
        }

        .tutorial-step.active {
            display: block;
        }

        .tutorial-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .auth-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .auth-card {
            background: var(--white);
            border-radius: 25px;
            padding: 3rem;
            text-align: center;
            box-shadow: 0 20px 60px var(--shadow);
            max-width: 600px;
            width: 100%;
        }

        .auth-card h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, var(--primary-pink), var(--secondary-lavender));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-options {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 2rem 0;
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-pink);
        }

        .form-help {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .form-warning {
            background: #fff3cd;
            border: 1px solid var(--warning);
            color: #856404;
            padding: 0.75rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-size: 0.9rem;
        }

        .storage-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        .storage-server {
            background: var(--mint-green);
            color: var(--text-dark);
        }

        .storage-private {
            background: var(--secondary-lavender);
            color: var(--text-dark);
        }

        .btn {
            background: var(--secondary-lavender);
            color: var(--text-dark);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: var(--primary-pink);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn.primary {
            background: var(--primary-pink);
        }

        .btn.primary:hover {
            background: var(--secondary-lavender);
        }

        .btn.secondary {
            background: var(--soft-blue);
        }

        .btn.success {
            background: var(--success);
            color: white;
        }

        .btn.danger {
            background: var(--error);
            color: white;
        }

        .alert {
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            text-align: center;
        }

        .alert.error {
            background: #ffeaea;
            color: var(--error);
            border: 1px solid var(--error);
        }

        .alert.success {
            background: #eafaf1;
            color: var(--success);
            border: 1px solid var(--success);
        }

        nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px var(--shadow);
            display: none;
        }

        nav.active {
            display: block;
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-menu li {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-menu li:hover, .nav-menu li.active {
            background: var(--secondary-lavender);
            transform: translateY(-2px);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .room-info {
            background: var(--mint-green);
            padding: 0.5rem 1rem;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .admin-badge {
            background: var(--warning);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 100px 2rem 2rem;
            min-height: 100vh;
            display: none;
        }

        .container.active {
            display: block;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .stat-card {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px var(--shadow);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 2.5rem;
            color: var(--primary-pink);
            margin-bottom: 0.5rem;
        }

        .card {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem;
            margin: 1rem 0;
            box-shadow: 0 10px 30px var(--shadow);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card.preserved {
            background: linear-gradient(135deg, #fff5e6, #ffe6e6);
            border: 2px solid var(--warning);
        }

        .preserved-banner {
            background: var(--warning);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: bold;
        }

        .content-item {
            background: var(--white);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 5px 20px var(--shadow);
        }

        .content-item img {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 1rem;
        }

        .request-item {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 15px;
            margin: 1rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 20px var(--shadow);
        }

        .request-actions {
            display: flex;
            gap: 0.5rem;
        }

        .image-upload {
            border: 2px dashed var(--text-light);
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 1rem 0;
        }

        .image-upload:hover {
            border-color: var(--primary-pink);
            background: rgba(248, 215, 218, 0.1);
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin-top: 1rem;
        }

        .chat-container {
            height: 400px;
            background: var(--white);
            border-radius: 20px;
            padding: 1rem;
            margin-bottom: 1rem;
            overflow-y: auto;
            box-shadow: inset 0 2px 10px var(--shadow);
        }

        .chat-message {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 15px;
            max-width: 70%;
        }

        .message-sent {
            background: var(--primary-pink);
            margin-left: auto;
            text-align: right;
        }

        .message-received {
            background: var(--soft-blue);
        }

        .chat-input-container {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 25px;
            background: var(--white);
            box-shadow: 0 2px 10px var(--shadow);
            font-size: 1rem;
        }

        .settings-section {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem;
            margin: 1rem 0;
            box-shadow: 0 10px 30px var(--shadow);
        }

        .danger-zone {
            border: 2px solid var(--error);
            background: #ffeaea;
        }

        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 1rem 0;
            overflow-x: auto;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .nav-menu {
                flex-wrap: wrap;
                gap: 0.5rem;
                font-size: 0.9rem;
            }

            .nav-content {
                flex-direction: column;
                gap: 1rem;
            }

            .container {
                padding: 150px 1rem 1rem;
            }

            .auth-options {
                flex-direction: column;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .request-item {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <div id="notificationButton" class="notification-button" onclick="showNotifications()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
        <div id="notificationBadge" class="notification-badge hidden">0</div>
    </div>

    <div id="helpButton" class="help-button" onclick="showTutorial()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
    </div>

    <!-- Tutorial Modal -->
    <div id="tutorialModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeTutorial()">√ó</button>
            
            <div class="tutorial-step active" data-step="1">
                <h2>Welcome to Our Space! üíï</h2>
                <p>A secure, self-hosted platform for couples to share memories, backed by GitHub.</p>
                
                <h3>üèóÔ∏è Architecture</h3>
                <ul>
                    <li><strong>Server Mode:</strong> Data stored in deployer's GitHub (free hosting)</li>
                    <li><strong>Private Mode:</strong> Data stored in your own GitHub repository</li>
                    <li>All room codes are unique globally</li>
                    <li>Seamless switching between modes</li>
                </ul>

                <h3>‚ú® Features</h3>
                <ul>
                    <li>üì∏ Memories with photos</li>
                    <li>üîó Shared links</li>
                    <li>üìù Sweet notes</li>
                    <li>üí¨ Real-time chat</li>
                    <li>üëë Admin approval system</li>
                    <li>üîí Preserve mode</li>
                    <li>üîÑ Server ‚Üî Private switching</li>
                </ul>
                
                <div class="tutorial-navigation">
                    <div></div>
                    <button class="btn primary" onclick="nextTutorialStep()">Next</button>
                </div>
            </div>

            <div class="tutorial-step" data-step="2">
                <h2>How It Works</h2>
                
                <h3>üñ•Ô∏è Server Mode (Default)</h3>
                <p>Your data is stored in the deployer's GitHub repository:</p>
                <ul>
                    <li>‚úÖ No setup required</li>
                    <li>‚úÖ Free hosting</li>
                    <li>‚úÖ Shared infrastructure</li>
                    <li>üìç All users start here</li>
                </ul>

                <h3>üîê Private Mode</h3>
                <p>Admin can switch to store data in your own GitHub:</p>
                <ul>
                    <li>‚úÖ Full data control</li>
                    <li>‚úÖ Private repository</li>
                    <li>‚úÖ Your own backup</li>
                    <li>üîÑ Can switch back to server anytime</li>
                </ul>

                <h3>üìã Files Created</h3>
                <ul>
                    <li><code>users_data.txt</code> - User accounts (server only)</li>
                    <li><code>master_rooms.txt</code> - Global room registry</li>
                    <li><code>export.txt</code> - Private mode tracking</li>
                    <li><code>{ROOMCODE}_master.txt</code> - Room file index</li>
                    <li><code>{ROOMCODE}_1.txt, _2.txt...</code> - Room data</li>
                </ul>
                
                <div class="tutorial-navigation">
                    <button class="btn" onclick="prevTutorialStep()">Back</button>
                    <button class="btn primary" onclick="nextTutorialStep()">Next</button>
                </div>
            </div>

            <div class="tutorial-step" data-step="3">
                <h2>User Registration</h2>
                
                <h3>üìù Registration Rules</h3>
                <ul>
                    <li><strong>Username:</strong> 3-30 characters, lowercase, letters/numbers/periods/underscores</li>
                    <li><strong>Display Name:</strong> How your partner sees you</li>
                    <li><strong>Password:</strong> Minimum 6 characters</li>
                    <li>‚ö†Ô∏è <strong>Password cannot be recovered!</strong> Note it safely</li>
                    <li>‚úÖ One username per person globally</li>
                </ul>

                <h3>üè† Room Management</h3>
                <ul>
                    <li>One room per user at a time</li>
                    <li>Room creator becomes admin</li>
                    <li>Admin approves new members</li>
                    <li>If admin leaves, next member becomes admin</li>
                    <li>6-character unique room codes</li>
                </ul>
                
                <div class="tutorial-navigation">
                    <button class="btn" onclick="prevTutorialStep()">Back</button>
                    <button class="btn primary" onclick="nextTutorialStep()">Next</button>
                </div>
            </div>

            <div class="tutorial-step" data-step="4">
                <h2>Storage Mode Switching</h2>
                
                <h3>üîÑ Server ‚Üí Private</h3>
                <p>Admin can move room to private storage:</p>
                <ol>
                    <li>Go to Settings page</li>
                    <li>Click "Switch to Private Storage"</li>
                    <li>Enter your GitHub repo and token</li>
                    <li>All room data copied to your repo</li>
                    <li>Room added to export.txt</li>
                    <li>Room still appears in master registry</li>
                </ol>

                <h3>üîÑ Private ‚Üí Server</h3>
                <p>Switch back to server storage:</p>
                <ol>
                    <li>Go to Settings page</li>
                    <li>Click "Switch to Server Storage"</li>
                    <li>All room data copied back to server</li>
                    <li>Removed from export.txt</li>
                    <li>Your private repo files can be deleted</li>
                </ol>

                <p class="form-warning">
                    <strong>Note:</strong> Only room data files are transferred. User accounts always stay on server.
                </p>
                
                <div class="tutorial-navigation">
                    <button class="btn" onclick="prevTutorialStep()">Back</button>
                    <button class="btn primary" onclick="nextTutorialStep()">Next</button>
                </div>
            </div>

            <div class="tutorial-step" data-step="5">
                <h2>Special Features</h2>
                
                <h3>üíî Breakup Options</h3>
                <p><strong>Delete Room:</strong></p>
                <ul>
                    <li>Requires all members to confirm</li>
                    <li>Permanently deletes all data</li>
                    <li>Removes from export.txt if private</li>
                    <li>Cannot be undone</li>
                </ul>

                <p><strong>üèõÔ∏è Preserve Mode:</strong></p>
                <ul>
                    <li>Freezes room forever (read-only)</li>
                    <li>No adding/deleting content</li>
                    <li>Memories locked forever</li>
                    <li>Cannot be undone</li>
                </ul>

                <p><strong>üö∂ Move On:</strong></p>
                <ul>
                    <li>Leave room silently</li>
                    <li>If all leave, auto-deletes</li>
                    <li>Removed from export.txt if applicable</li>
                </ul>

                <h3>üîî Admin Features</h3>
                <ul>
                    <li>Approve/deny join requests</li>
                    <li>Switch storage modes</li>
                    <li>Configure private storage</li>
                    <li>Bell icon shows pending requests</li>
                </ul>
                
                <div class="tutorial-navigation">
                    <button class="btn" onclick="prevTutorialStep()">Back</button>
                    <button class="btn primary" onclick="nextTutorialStep()">Next</button>
                </div>
            </div>

            <div class="tutorial-step" data-step="6">
                <h2>Important Reminders ‚ö†Ô∏è</h2>
                
                <h3>üîê Security</h3>
                <ul>
                    <li><strong>Password:</strong> Cannot be recovered! Write it down safely</li>
                    <li><strong>Server Token:</strong> Set by deployer, never share</li>
                    <li><strong>Private Token:</strong> Your personal access token, keep secret</li>
                    <li>Use strong, unique passwords</li>
                </ul>

                <h3>üíæ Data</h3>
                <ul>
                    <li>Server mode: Data hosted by deployer</li>
                    <li>Private mode: Data in your GitHub</li>
                    <li>Images stored as base64 (not split)</li>
                    <li>50MB file size limits (auto-splits)</li>
                </ul>

                <h3>üåê Room Codes</h3>
                <ul>
                    <li>All room codes globally unique</li>
                    <li>Tracked in master_rooms.txt</li>
                    <li>No duplicates possible</li>
                    <li>6 characters, case-sensitive</li>
                </ul>

                <h3>üì§ Export System</h3>
                <ul>
                    <li>export.txt tracks private rooms</li>
                    <li>Auto-removed on switch to server</li>
                    <li>Auto-removed on room deletion</li>
                    <li>Auto-removed when all users leave</li>
                </ul>
                
                <div class="tutorial-navigation">
                    <button class="btn" onclick="prevTutorialStep()">Back</button>
                    <button class="btn primary" onclick="closeTutorial()">Get Started!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notificationsModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeNotifications()">√ó</button>
            <h2>Join Requests üîî</h2>
            <div id="notificationsContainer"></div>
        </div>
    </div>

    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <h1>Our Space üíï</h1>
            <p>A private sanctuary for couples, powered by GitHub</p>
            <div id="storageIndicator" class="storage-badge storage-server">Server Mode</div>
            
            <!-- Initial Choice -->
            <div id="initialChoice">
                <div class="auth-options">
                    <button class="btn primary" onclick="showRegisterForm()">Register</button>
                    <button class="btn secondary" onclick="showLoginForm()">Login</button>
                </div>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <h2>Create Account</h2>
                
                <div class="form-group">
                    <label for="regUsername">Username *</label>
                    <input type="text" id="regUsername" placeholder="lowercase_username" maxlength="30">
                    <div class="form-help">3-30 characters, lowercase, letters/numbers/./\_</div>
                </div>

                <div class="form-group">
                    <label for="regDisplayName">Display Name *</label>
                    <input type="text" id="regDisplayName" placeholder="How your partner sees you">
                </div>
                
                <div class="form-group">
                    <label for="regPassword">Password *</label>
                    <input type="password" id="regPassword" placeholder="Create a strong password">
                    <div class="form-warning">
                        ‚ö†Ô∏è <strong>CRITICAL:</strong> Password CANNOT be recovered. If forgotten, account is lost forever. Write it down safely!
                    </div>
                </div>
                
                <div id="regAlert"></div>
                
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn" onclick="backToAuthChoice()">Back</button>
                    <button class="btn primary" onclick="registerUser()">Register</button>
                </div>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="hidden">
                <h2>Login</h2>
                
                <div class="form-group">
                    <label for="loginUsername">Username</label>
                    <input type="text" id="loginUsername" placeholder="your_username">
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password">
                </div>
                
                <div id="loginAlert"></div>
                
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn" onclick="backToAuthChoice()">Back</button>
                    <button class="btn primary" onclick="loginUser()">Login</button>
                </div>
            </div>

            <!-- Room Choice -->
            <div id="roomChoice" class="hidden">
                <h2>Room Options</h2>
                <p id="roomStatusMessage"></p>
                
                <div class="auth-options">
                    <button class="btn primary" id="createRoomBtn" onclick="showCreateRoomForm()">Create New Room</button>
                    <button class="btn secondary" id="joinRoomBtn" onclick="showJoinRoomForm()">Join Existing Room</button>
                </div>
            </div>

            <!-- Create Room Form -->
            <div id="createRoomForm" class="hidden">
                <h2>Create Your Room</h2>
                <p style="margin-bottom: 1rem; color: var(--text-light);">
                    You'll be the admin. Room stored on server by default.
                </p>
                
                <div id="createRoomAlert"></div>
                
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn" onclick="backToRoomChoice()">Back</button>
                    <button class="btn primary" onclick="createRoom()">Create Room</button>
                </div>
            </div>

            <!-- Join Room Form -->
            <div id="joinRoomForm" class="hidden">
                <h2>Join Existing Room</h2>
                
                <div class="form-group">
                    <label for="joinRoomCode">Room Code</label>
                    <input type="text" id="joinRoomCode" placeholder="6-character code" maxlength="6">
                </div>
                
                <div id="joinRoomAlert"></div>
                
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn" onclick="backToRoomChoice()">Back</button>
                    <button class="btn primary" onclick="requestJoinRoom()">Request to Join</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav id="mainNav">
        <div class="nav-content">
            <ul class="nav-menu">
                <li class="nav-item active" data-page="home">üè† Dashboard</li>
                <li class="nav-item" data-page="memories">üì∏ Memories</li>
                <li class="nav-item" data-page="links">üîó Links</li>
                <li class="nav-item" data-page="notes">üìù Notes</li>
                <li class="nav-item" data-page="chat">üí¨ Chat</li>
                <li class="nav-item" data-page="settings">‚öôÔ∏è Settings</li>
            </ul>
            <div class="user-info">
                <div id="roomInfoDisplay" class="room-info"></div>
                <span id="storageModeBadge" class="storage-badge storage-server">Server</span>
                <span id="adminBadge" class="admin-badge hidden">ADMIN</span>
                <span id="userDisplayName"></span>
                <button class="btn danger" style="padding: 0.5rem 1rem; font-size: 0.9rem;" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div id="mainContainer" class="container">
        <!-- Dashboard Page -->
        <div id="home" class="page active">
            <div class="card" id="dashboardCard">
                <h2>Welcome to Our Space üíï</h2>
                <p id="welcomeMessage">Your shared sanctuary for memories and moments</p>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3 id="memoriesCount">0</h3>
                    <p>Precious Memories</p>
                </div>
                <div class="stat-card">
                    <h3 id="notesCount">0</h3>
                    <p>Sweet Notes</p>
                </div>
                <div class="stat-card">
                    <h3 id="linksCount">0</h3>
                    <p>Shared Links</p>
                </div>
                <div class="stat-card">
                    <h3 id="messagesCount">0</h3>
                    <p>Messages Exchanged</p>
                </div>
            </div>

            <div class="card">
                <h2>Quick Actions</h2>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
                    <button class="btn" onclick="showPage('memories')" id="addMemoryBtn">Add Memory</button>
                    <button class="btn" onclick="showPage('notes')" id="addNoteBtn">Write Note</button>
                    <button class="btn" onclick="showPage('links')" id="addLinkBtn">Save Link</button>
                    <button class="btn" onclick="showPage('chat')" id="startChatBtn">Start Chat</button>
                </div>
            </div>

            <div class="card">
                <h2>Recent Activity</h2>
                <div id="recentActivity"></div>
            </div>
        </div>

        <!-- Memories, Links, Notes, Chat Pages... (keeping existing structure) -->
        <div id="memories" class="page">
            <div class="card" id="memoriesCard">
                <h2>Our Memories üì∏</h2>
                
                <div id="memoryForm">
                    <div class="form-group">
                        <label for="memoryTitle">Memory Title</label>
                        <input type="text" id="memoryTitle" placeholder="Enter memory title">
                    </div>
                    
                    <div class="form-group">
                        <label for="memoryDescription">Description</label>
                        <textarea id="memoryDescription" placeholder="Describe this special moment..." rows="4"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="memoryDate">Date</label>
                        <input type="date" id="memoryDate">
                    </div>
                    
                    <div class="form-group">
                        <label>Add Photo (Optional)</label>
                        <div class="image-upload" onclick="document.getElementById('memoryImage').click()">
                            <p>üì∑ Click to upload a photo</p>
                            <p style="font-size: 0.9rem; color: var(--text-light);">Maximum 5MB</p>
                        </div>
                        <input type="file" id="memoryImage" accept="image/*" style="display: none;" onchange="previewMemoryImage(this)">
                        <img id="memoryImagePreview" class="image-preview hidden">
                    </div>
                    
                    <button class="btn primary" onclick="addMemory()">Add Memory</button>
                </div>
            </div>

            <div id="memoriesContainer"></div>
        </div>

        <div id="links" class="page">
            <div class="card" id="linksCard">
                <h2>Our Links üîó</h2>
                
                <div id="linkForm">
                    <div class="form-group">
                        <label for="linkTitle">Link Title</label>
                        <input type="text" id="linkTitle" placeholder="Enter link title">
                    </div>
                    
                    <div class="form-group">
                        <label for="linkUrl">URL</label>
                        <input type="url" id="linkUrl" placeholder="https://example.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="linkDescription">Description</label>
                        <textarea id="linkDescription" placeholder="Why is this link special?" rows="3"></textarea>
                    </div>
                    
                    <button class="btn primary" onclick="addLink()">Save Link</button>
                </div>
            </div>

            <div id="linksContainer"></div>
        </div>

        <div id="notes" class="page">
            <div class="card" id="notesCard">
                <h2>Our Notes üìù</h2>
                
                <div id="noteForm">
                    <div class="form-group">
                        <label for="noteTitle">Note Title</label>
                        <input type="text" id="noteTitle" placeholder="Enter note title">
                    </div>
                    
                    <div class="form-group">
                        <label for="noteContent">Message</label>
                        <textarea id="noteContent" placeholder="Write your sweet message..." rows="5"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Add Image (Optional)</label>
                        <div class="image-upload" onclick="document.getElementById('noteImage').click()">
                            <p>üì∑ Click to upload an image</p>
                            <p style="font-size: 0.9rem; color: var(--text-light);">Maximum 5MB</p>
                        </div>
                        <input type="file" id="noteImage" accept="image/*" style="display: none;" onchange="previewNoteImage(this)">
                        <img id="noteImagePreview" class="image-preview hidden">
                    </div>
                    
                    <button class="btn primary" onclick="addNote()">Save Note</button>
                </div>
            </div>

            <div id="notesContainer"></div>
        </div>

        <div id="chat" class="page">
            <div class="card" id="chatCard">
                <h2>Private Chat üí¨</h2>
                <div class="chat-container" id="chatContainer"></div>
                
                <div class="chat-input-container" id="chatInputContainer">
                    <input type="text" class="chat-input" placeholder="Type your message..." id="messageInput">
                    <button class="btn primary" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settings" class="page">
            <div class="settings-section">
                <h2>Room Information ‚öôÔ∏è</h2>
                <div style="margin-top: 1rem;">
                    <p><strong>Room Code:</strong> <span id="settingsRoomCode"></span></p>
                    <p><strong>Storage Mode:</strong> <span id="settingsStorageMode"></span></p>
                    <p><strong>Members:</strong> <span id="settingsMemberCount"></span></p>
                    <p><strong>Your Role:</strong> <span id="settingsRole"></span></p>
                    <p><strong>Created:</strong> <span id="settingsCreated"></span></p>
                </div>
            </div>

            <!-- Storage Management (Admin Only) -->
            <div id="storageManagement" class="settings-section hidden">
                <h2>üîÑ Storage Management (Admin Only)</h2>
                <p>Switch between server and private storage modes.</p>
                
                <div id="currentStorageInfo" style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 10px;">
                    <p><strong>Current Mode:</strong> <span id="currentMode">Server</span></p>
                    <p id="privateRepoInfo" class="hidden"><strong>Private Repo:</strong> <span id="privateRepo"></span></p>
                </div>

                <div id="switchToPrivateSection" class="hidden">
                    <h3>Switch to Private Storage</h3>
                    <p style="margin: 0.5rem 0;">Store room data in your own GitHub repository.</p>
                    
                    <div class="form-group">
                        <label for="privateGithubRepo">Your GitHub Repository</label>
                        <input type="text" id="privateGithubRepo" placeholder="username/repository-name">
                        <div class="form-help">Both partners should use the SAME repository</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="privateGithubToken">Your Personal Access Token</label>
                        <input type="password" id="privateGithubToken" placeholder="ghp_...">
                        <div class="form-help">Generate from github.com/settings/tokens</div>
                    </div>
                    
                    <button class="btn" onclick="switchToPrivate()" style="background: var(--secondary-lavender);">Switch to Private</button>
                </div>

                <div id="switchToServerSection" class="hidden">
                    <h3>Switch to Server Storage</h3>
                    <p style="margin: 0.5rem 0;">Move room data back to server storage.</p>
                    <button class="btn" onclick="switchToServer()" style="background: var(--mint-green);">Switch to Server</button>
                </div>
            </div>

            <div class="settings-section danger-zone">
                <h2>‚ö†Ô∏è Danger Zone</h2>
                
                <div style="margin: 1.5rem 0;">
                    <h3>üèõÔ∏è Preserve Room</h3>
                    <p>Freeze this room forever. No new content, no deletions. CANNOT be undone.</p>
                    <button class="btn" onclick="preserveRoom()" style="background: var(--warning); color: white; margin-top: 0.5rem;">Preserve Room</button>
                </div>

                <div style="margin: 1.5rem 0;">
                    <h3>üö∂ Move On</h3>
                    <p>Leave room silently. If all leave, room auto-deletes.</p>
                    <button class="btn" onclick="moveOn()" style="background: var(--text-light); color: white; margin-top: 0.5rem;">Move On</button>
                </div>

                <div style="margin: 1.5rem 0;">
                    <h3>üíî Delete Room (Breakup)</h3>
                    <p>Permanently delete room. Requires all members to confirm. CANNOT be undone.</p>
                    <button class="btn danger" onclick="initiateBreakup()" style="margin-top: 0.5rem;">Request Deletion</button>
                    <div id="breakupStatus" style="margin-top: 1rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // Configuration - Will be loaded from config.js
        let serverConfig = window.SERVER_CONFIG || {
            githubRepo: '',
            githubToken: ''
        };

        let config = {
            githubRepo: serverConfig.githubRepo,
            githubToken: serverConfig.githubToken,
            usersFile: 'users_data.txt',
            masterRoomsFile: 'master_rooms.txt',
            exportFile: 'export.txt',
            maxFileSize: 50 * 1024 * 1024
        };

        // Global state
        let currentUser = null;
        let currentRoom = null;
        let roomData = {};
        let currentTutorialStep = 1;
        let allUsers = {};
        let masterRooms = {};
        let exportedRooms = {};
        let isAdmin = false;
        let isPreserved = false;
        let storageMode = 'server'; // 'server' or 'private'
        let privateConfig = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (!config.githubRepo || !config.githubToken) {
                showAlert('Server not configured. Please contact administrator.', 'error');
                return;
            }
            checkIfNewUser();
            setupEventListeners();
        });

        function checkIfNewUser() {
            const hasVisited = localStorage.getItem('hasVisited');
            if (!hasVisited) {
                localStorage.setItem('hasVisited', 'true');
                setTimeout(() => showTutorial(), 500);
            }
            checkAuthState();
        }

        // Tutorial functions
        function showTutorial() {
            document.getElementById('tutorialModal').classList.add('active');
            currentTutorialStep = 1;
            showTutorialStep(1);
        }

        function closeTutorial() {
            document.getElementById('tutorialModal').classList.remove('active');
        }

        function showTutorialStep(step) {
            document.querySelectorAll('.tutorial-step').forEach(s => s.classList.remove('active'));
            const stepEl = document.querySelector(`.tutorial-step[data-step="${step}"]`);
            if (stepEl) stepEl.classList.add('active');
        }

        function nextTutorialStep() {
            if (currentTutorialStep < 6) {
                currentTutorialStep++;
                showTutorialStep(currentTutorialStep);
            }
        }

        function prevTutorialStep() {
            if (currentTutorialStep > 1) {
                currentTutorialStep--;
                showTutorialStep(currentTutorialStep);
            }
        }

        // Auth State
        function checkAuthState() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                loadUserRooms();
            }
        }

        // Auth UI
        function showRegisterForm() {
            document.getElementById('initialChoice').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function showLoginForm() {
            document.getElementById('initialChoice').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        function backToAuthChoice() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('initialChoice').classList.remove('hidden');
        }

        function backToRoomChoice() {
            document.getElementById('createRoomForm').classList.add('hidden');
            document.getElementById('joinRoomForm').classList.add('hidden');
            document.getElementById('roomChoice').classList.remove('hidden');
        }

        function showCreateRoomForm() {
            document.getElementById('roomChoice').classList.add('hidden');
            document.getElementById('createRoomForm').classList.remove('hidden');
        }

        function showJoinRoomForm() {
            document.getElementById('roomChoice').classList.add('hidden');
            document.getElementById('joinRoomForm').classList.remove('hidden');
        }

        // GitHub API Functions
        async function loadFromGitHub(fileName, usePrivate = false) {
            const cfg = usePrivate && privateConfig ? privateConfig : config;
            try {
                const response = await fetch(`https://api.github.com/repos/${cfg.githubRepo}/contents/${fileName}`, {
                    headers: {
                        'Authorization': `token ${cfg.githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    return {
                        content: JSON.parse(decodeURIComponent(escape(atob(data.content)))),
                        sha: data.sha
                    };
                }
            } catch (error) {
                console.error(`Error loading ${fileName}:`, error);
            }
            return null;
        }

        async function saveToGitHub(fileName, content, sha = null, usePrivate = false) {
            const cfg = usePrivate && privateConfig ? privateConfig : config;
            const encodedContent = btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2))));

            const body = {
                message: sha ? `Update ${fileName}` : `Create ${fileName}`,
                content: encodedContent
            };

            if (sha) body.sha = sha;

            const response = await fetch(`https://api.github.com/repos/${cfg.githubRepo}/contents/${fileName}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${cfg.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                throw new Error(`Failed to save ${fileName}`);
            }

            return await response.json();
        }

        async function deleteFromGitHub(fileName, sha, usePrivate = false) {
            const cfg = usePrivate && privateConfig ? privateConfig : config;
            await fetch(`https://api.github.com/repos/${cfg.githubRepo}/contents/${fileName}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `token ${cfg.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Delete ${fileName}`,
                    sha: sha
                })
            });
        }

        // User Management
        function validateUsername(username) {
            if (username.length < 3 || username.length > 30) {
                return 'Username must be between 3 and 30 characters';
            }
            if (!/^[a-z0-9._]+$/.test(username)) {
                return 'Username can only contain lowercase letters, numbers, periods, and underscores';
            }
            if (username !== username.toLowerCase()) {
                return 'Username must be lowercase';
            }
            return null;
        }

        async function loadAllUsers() {
            const fileData = await loadFromGitHub(config.usersFile);
            allUsers = fileData ? fileData.content : {};
        }

        async function saveAllUsers() {
            const fileData = await loadFromGitHub(config.usersFile);
            await saveToGitHub(config.usersFile, allUsers, fileData?.sha);
        }

        async function loadMasterRooms() {
            const fileData = await loadFromGitHub(config.masterRoomsFile);
            masterRooms = fileData ? fileData.content : {};
        }

        async function saveMasterRooms() {
            const fileData = await loadFromGitHub(config.masterRoomsFile);
            await saveToGitHub(config.masterRoomsFile, masterRooms, fileData?.sha);
        }

        async function loadExportedRooms() {
            const fileData = await loadFromGitHub(config.exportFile);
            exportedRooms = fileData ? fileData.content : {};
        }

        async function saveExportedRooms() {
            const fileData = await loadFromGitHub(config.exportFile);
            await saveToGitHub(config.exportFile, exportedRooms, fileData?.sha);
        }

        async function registerUser() {
            const username = document.getElementById('regUsername').value.trim().toLowerCase();
            const displayName = document.getElementById('regDisplayName').value.trim();
            const password = document.getElementById('regPassword').value;

            const usernameError = validateUsername(username);
            if (usernameError) {
                showAlert(usernameError, 'error', 'regAlert');
                return;
            }

            if (!displayName || !password) {
                showAlert('Please fill in all fields', 'error', 'regAlert');
                return;
            }

            if (password.length < 6) {
                showAlert('Password must be at least 6 characters', 'error', 'regAlert');
                return;
            }

            showLoading(true);

            try {
                await loadAllUsers();

                if (allUsers[username]) {
                    showLoading(false);
                    showAlert('Username already exists', 'error', 'regAlert');
                    return;
                }

                allUsers[username] = {
                    username: username,
                    displayName: displayName,
                    password: btoa(password),
                    created: new Date().toISOString(),
                    rooms: [],
                    currentRoom: null,
                    pendingRoomRequest: null
                };

                await saveAllUsers();

                currentUser = {
                    username: username,
                    displayName: displayName
                };

                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                showAlert('Account created successfully!', 'success', 'regAlert');
                
                setTimeout(() => {
                    showRoomChoice();
                }, 1500);

            } catch (error) {
                showLoading(false);
                showAlert('Registration failed. Please try again.', 'error', 'regAlert');
                console.error('Registration error:', error);
            }
        }

        async function loginUser() {
            const username = document.getElementById('loginUsername').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showAlert('Please fill in all fields', 'error', 'loginAlert');
                return;
            }

            showLoading(true);

            try {
                await loadAllUsers();

                if (!allUsers[username]) {
                    showLoading(false);
                    showAlert('User not found', 'error', 'loginAlert');
                    return;
                }

                const user = allUsers[username];
                if (user.password !== btoa(password)) {
                    showLoading(false);
                    showAlert('Invalid password', 'error', 'loginAlert');
                    return;
                }

                currentUser = {
                    username: username,
                    displayName: user.displayName
                };

                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                showAlert('Login successful!', 'success', 'loginAlert');
                
                setTimeout(() => {
                    loadUserRooms();
                }, 1000);

            } catch (error) {
                showLoading(false);
                showAlert('Login failed. Please try again.', 'error', 'loginAlert');
                console.error('Login error:', error);
            }
        }

        async function loadUserRooms() {
            showLoading(true);
            try {
                await loadAllUsers();
                const userData = allUsers[currentUser.username];

                if (userData.currentRoom) {
                    currentRoom = userData.currentRoom;
                    await loadRoomData();
                } else if (userData.pendingRoomRequest) {
                    showRoomChoice();
                    const msg = document.getElementById('roomStatusMessage');
                    msg.textContent = 'You have a pending room request. Please wait for approval.';
                    msg.style.color = 'var(--warning)';
                } else {
                    showRoomChoice();
                }
            } catch (error) {
                showLoading(false);
                showAlert('Failed to load user data', 'error');
                console.error('Load error:', error);
            }
        }

        function showRoomChoice() {
            showLoading(false);
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('initialChoice').classList.add('hidden');
            document.getElementById('roomChoice').classList.remove('hidden');
            
            const userData = allUsers[currentUser.username];
            const statusMsg = document.getElementById('roomStatusMessage');
            
            if (userData.pendingRoomRequest) {
                statusMsg.textContent = `Pending request for room: ${userData.pendingRoomRequest}`;
                statusMsg.style.color = 'var(--warning)';
                document.getElementById('createRoomBtn').disabled = true;
                document.getElementById('joinRoomBtn').disabled = true;
            } else {
                statusMsg.textContent = 'Choose an option:';
                statusMsg.style.color = 'var(--text-light)';
                document.getElementById('createRoomBtn').disabled = false;
                document.getElementById('joinRoomBtn').disabled = false;
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('currentUser');
                location.reload();
            }
        }

        // Room Management
        function generateRoomCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        async function createRoom() {
            showLoading(true);
            try {
                await loadMasterRooms();
                
                let roomCode;
                let attempts = 0;
                do {
                    roomCode = generateRoomCode();
                    attempts++;
                    if (attempts > 100) {
                        showLoading(false);
                        showAlert('Failed to generate unique room code. Please try again.', 'error', 'createRoomAlert');
                        return;
                    }
                } while (masterRooms[roomCode]);

                const masterFileName = `${roomCode}_master.txt`;
                const roomFileName = `${roomCode}_1.txt`;

                const roomMaster = {
                    code: roomCode,
                    files: [roomFileName],
                    created: new Date().toISOString(),
                    storageMode: 'server'
                };

                roomData = {
                    code: roomCode,
                    admin: currentUser.username,
                    adminHistory: [currentUser.username],
                    created: new Date().toISOString(),
                    preserved: false,
                    breakupRequests: {},
                    members: [{
                        username: currentUser.username,
                        displayName: currentUser.displayName,
                        joinedAt: new Date().toISOString()
                    }],
                    joinRequests: [],
                    memories: [],
                    links: [],
                    notes: [],
                    messages: []
                };

                await saveToGitHub(masterFileName, roomMaster);
                await saveToGitHub(roomFileName, roomData);

                masterRooms[roomCode] = {
                    created: new Date().toISOString(),
                    storageMode: 'server'
                };
                await saveMasterRooms();

                allUsers[currentUser.username].currentRoom = roomCode;
                allUsers[currentUser.username].rooms.push({
                    code: roomCode,
                    joinedAt: new Date().toISOString()
                });
                await saveAllUsers();

                currentRoom = roomCode;
                isAdmin = true;
                storageMode = 'server';

                showAlert(`Room created! Code: ${roomCode}`, 'success', 'createRoomAlert');
                
                setTimeout(() => {
                    showMainApp();
                }, 2000);

            } catch (error) {
                showLoading(false);
                showAlert('Failed to create room', 'error', 'createRoomAlert');
                console.error('Create room error:', error);
            }
        }

        async function requestJoinRoom() {
            const roomCode = document.getElementById('joinRoomCode').value.trim().toUpperCase();

            if (!roomCode || roomCode.length !== 6) {
                showAlert('Please enter a valid 6-character room code', 'error', 'joinRoomAlert');
                return;
            }

            showLoading(true);

            try {
                await loadMasterRooms();

                if (!masterRooms[roomCode]) {
                    showLoading(false);
                    showAlert('Room not found', 'error', 'joinRoomAlert');
                    return;
                }

                const roomStorageMode = masterRooms[roomCode].storageMode;
                const usePrivate = roomStorageMode === 'private';

                if (usePrivate) {
                    await loadExportedRooms();
                    if (!exportedRooms[roomCode]) {
                        showLoading(false);
                        showAlert('Private room configuration not found', 'error', 'joinRoomAlert');
                        return;
                    }
                    privateConfig = exportedRooms[roomCode].config;
                }

                const masterFileName = `${roomCode}_master.txt`;
                const masterFile = await loadFromGitHub(masterFileName, usePrivate);

                if (!masterFile) {
                    showLoading(false);
                    showAlert('Room data not found', 'error', 'joinRoomAlert');
                    return;
                }

                const roomFile = await loadFromGitHub(masterFile.content.files[0], usePrivate);
                if (!roomFile) {
                    showLoading(false);
                    showAlert('Room data not accessible', 'error', 'joinRoomAlert');
                    return;
                }

                const room = roomFile.content;

                if (room.members.find(m => m.username === currentUser.username)) {
                    showLoading(false);
                    showAlert('You are already a member of this room', 'error', 'joinRoomAlert');
                    return;
                }

                if (room.joinRequests.find(r => r.username === currentUser.username)) {
                    showLoading(false);
                    showAlert('You already have a pending request', 'error', 'joinRoomAlert');
                    return;
                }

                room.joinRequests.push({
                    username: currentUser.username,
                    displayName: currentUser.displayName,
                    requestedAt: new Date().toISOString()
                });

                await saveToGitHub(masterFile.content.files[0], room, roomFile.sha, usePrivate);

                allUsers[currentUser.username].pendingRoomRequest = roomCode;
                await saveAllUsers();

                showAlert('Join request sent! Please wait for admin approval.', 'success', 'joinRoomAlert');
                
                setTimeout(() => {
                    showRoomChoice();
                }, 2000);

            } catch (error) {
                showLoading(false);
                showAlert('Failed to send join request', 'error', 'joinRoomAlert');
                console.error('Join request error:', error);
            }
        }

        async function loadRoomData() {
            showLoading(true);
            try {
                await loadMasterRooms();

                if (!masterRooms[currentRoom]) {
                    showLoading(false);
                    showAlert('Room not found in master registry', 'error');
                    await cleanupUser();
                    return;
                }

                storageMode = masterRooms[currentRoom].storageMode;
                const usePrivate = storageMode === 'private';

                if (usePrivate) {
                    await loadExportedRooms();
                    if (exportedRooms[currentRoom]) {
                        privateConfig = exportedRooms[currentRoom].config;
                    }
                }

                const masterFileName = `${currentRoom}_master.txt`;
                const masterFile = await loadFromGitHub(masterFileName, usePrivate);

                if (!masterFile) {
                    showLoading(false);
                    showAlert('Room master file not found', 'error');
                    await cleanupUser();
                    return;
                }

                let mergedData = {};
                for (const fileName of masterFile.content.files) {
                    const fileData = await loadFromGitHub(fileName, usePrivate);
                    if (fileData) {
                        mergedData = { ...mergedData, ...fileData.content };
                    }
                }

                roomData = mergedData;
                isAdmin = roomData.admin === currentUser.username;
                isPreserved = roomData.preserved || false;

                showMainApp();

            } catch (error) {
                showLoading(false);
                showAlert('Failed to load room data', 'error');
                console.error('Load room error:', error);
            }
        }

        async function cleanupUser() {
            allUsers[currentUser.username].currentRoom = null;
            await saveAllUsers();
            localStorage.removeItem('currentUser');
            location.reload();
        }

        async function saveRoomData() {
            if (!currentRoom || !roomData) return;

            try {
                const usePrivate = storageMode === 'private';
                const masterFileName = `${currentRoom}_master.txt`;
                const masterFile = await loadFromGitHub(masterFileName, usePrivate);

                if (!masterFile) return;

                const dataString = JSON.stringify(roomData);
                const dataSize = new Blob([dataString]).size;

                if (dataSize > config.maxFileSize) {
                    await splitRoomData(masterFile, usePrivate);
                } else {
                    const firstFile = masterFile.content.files[0];
                    const fileData = await loadFromGitHub(firstFile, usePrivate);
                    await saveToGitHub(firstFile, roomData, fileData?.sha, usePrivate);
                }

            } catch (error) {
                console.error('Save error:', error);
                showAlert('Failed to save data', 'error');
            }
        }

        async function splitRoomData(masterFile, usePrivate) {
            const baseData = {
                code: roomData.code,
                admin: roomData.admin,
                adminHistory: roomData.adminHistory,
                created: roomData.created,
                preserved: roomData.preserved,
                breakupRequests: roomData.breakupRequests,
                members: roomData.members,
                joinRequests: roomData.joinRequests
            };

            const files = [];
            let fileIndex = 1;

            const baseFileName = `${currentRoom}_${fileIndex}.txt`;
            const baseFile = await loadFromGitHub(baseFileName, usePrivate);
            await saveToGitHub(baseFileName, { ...baseData, memories: [], links: [], notes: [], messages: [] }, baseFile?.sha, usePrivate);
            files.push(baseFileName);
            fileIndex++;

            if (roomData.memories && roomData.memories.length > 0) {
                const memoriesFileName = `${currentRoom}_${fileIndex}.txt`;
                const memoriesFile = await loadFromGitHub(memoriesFileName, usePrivate);
                await saveToGitHub(memoriesFileName, { ...baseData, memories: roomData.memories, links: [], notes: [], messages: [] }, memoriesFile?.sha, usePrivate);
                files.push(memoriesFileName);
                fileIndex++;
            }

            if (roomData.notes && roomData.notes.length > 0) {
                const notesFileName = `${currentRoom}_${fileIndex}.txt`;
                const notesFile = await loadFromGitHub(notesFileName, usePrivate);
                await saveToGitHub(notesFileName, { ...baseData, memories: [], links: [], notes: roomData.notes, messages: [] }, notesFile?.sha, usePrivate);
                files.push(notesFileName);
                fileIndex++;
            }

            const miscFileName = `${currentRoom}_${fileIndex}.txt`;
            const miscFile = await loadFromGitHub(miscFileName, usePrivate);
            await saveToGitHub(miscFileName, { ...baseData, memories: [], links: roomData.links || [], notes: [], messages: roomData.messages || [] }, miscFile?.sha, usePrivate);
            files.push(miscFileName);

            masterFile.content.files = files;
            await saveToGitHub(`${currentRoom}_master.txt`, masterFile.content, masterFile.sha, usePrivate);
        }

        // Storage Mode Switching
        async function switchToPrivate() {
            const repo = document.getElementById('privateGithubRepo').value.trim();
            const token = document.getElementById('privateGithubToken').value.trim();

            if (!repo || !token || !repo.includes('/')) {
                showAlert('Please provide valid GitHub repository and token', 'error');
                return;
            }

            if (!confirm('Switch to private storage? All room data will be copied to your GitHub repository.')) {
                return;
            }

            showLoading(true);

            try {
                privateConfig = {
                    githubRepo: repo,
                    githubToken: token
                };

                const testResponse = await fetch(`https://api.github.com/repos/${repo}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!testResponse.ok) {
                    showLoading(false);
                    showAlert('Cannot access private repository. Check credentials.', 'error');
                    return;
                }

                const masterFileName = `${currentRoom}_master.txt`;
                const masterFile = await loadFromGitHub(masterFileName, false);

                for (const fileName of masterFile.content.files) {
                    const fileData = await loadFromGitHub(fileName, false);
                    if (fileData) {
                        await saveToGitHub(fileName, fileData.content, null, true);
                    }
                }

                masterFile.content.storageMode = 'private';
                await saveToGitHub(masterFileName, masterFile.content, null, true);

                await loadExportedRooms();
                exportedRooms[currentRoom] = {
                    roomCode: currentRoom,
                    exportedAt: new Date().toISOString(),
                    exportedBy: currentUser.username,
                    config: privateConfig
                };
                await saveExportedRooms();

                await loadMasterRooms();
                masterRooms[currentRoom].storageMode = 'private';
                await saveMasterRooms();

                storageMode = 'private';

                showLoading(false);
                showAlert('Successfully switched to private storage!', 'success');
                updateUI();

            } catch (error) {
                showLoading(false);
                showAlert('Failed to switch to private storage', 'error');
                console.error('Switch error:', error);
            }
        }

        async function switchToServer() {
            if (!confirm('Switch to server storage? All room data will be copied back to server.')) {
                return;
            }

            showLoading(true);

            try {
                const masterFileName = `${currentRoom}_master.txt`;
                const masterFile = await loadFromGitHub(masterFileName, true);

                for (const fileName of masterFile.content.files) {
                    const fileData = await loadFromGitHub(fileName, true);
                    if (fileData) {
                        await saveToGitHub(fileName, fileData.content, null, false);
                    }
                }

                masterFile.content.storageMode = 'server';
                await saveToGitHub(masterFileName, masterFile.content, null, false);

                await loadExportedRooms();
                delete exportedRooms[currentRoom];
                await saveExportedRooms();

                await loadMasterRooms();
                masterRooms[currentRoom].storageMode = 'server';
                await saveMasterRooms();

                storageMode = 'server';
                privateConfig = null;

                showLoading(false);
                showAlert('Successfully switched to server storage!', 'success');
                updateUI();

            } catch (error) {
                showLoading(false);
                showAlert('Failed to switch to server storage', 'error');
                console.error('Switch error:', error);
            }
        }

        // Notification System
        function showNotifications() {
            if (!isAdmin) return;

            const modal = document.getElementById('notificationsModal');
            const container = document.getElementById('notificationsContainer');

            if (!roomData.joinRequests || roomData.joinRequests.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No pending requests</p></div>';
            } else {
                container.innerHTML = roomData.joinRequests.map(req => `
                    <div class="request-item">
                        <div>
                            <strong>${req.displayName}</strong> (@${req.username})
                            <br>
                            <small>Requested: ${new Date(req.requestedAt).toLocaleString()}</small>
                        </div>
                        <div class="request-actions">
                            <button class="btn success" onclick="approveJoinRequest('${req.username}')">Approve</button>
                            <button class="btn danger" onclick="denyJoinRequest('${req.username}')">Deny</button>
                        </div>
                    </div>
                `).join('');
            }

            modal.classList.add('active');
        }

        function closeNotifications() {
            document.getElementById('notificationsModal').classList.remove('active');
        }

        async function approveJoinRequest(username) {
            showLoading(true);
            try {
                const requestIndex = roomData.joinRequests.findIndex(r => r.username === username);
                const request = roomData.joinRequests[requestIndex];
                roomData.joinRequests.splice(requestIndex, 1);

                roomData.members.push({
                    username: username,
                    displayName: request.displayName,
                    joinedAt: new Date().toISOString()
                });

                roomData.messages.push({
                    id: `msg_${Date.now()}`,
                    content: `${request.displayName} joined the room`,
                    author: 'system',
                    timestamp: new Date().toISOString(),
                    type: 'system'
                });

                await saveRoomData();

                await loadAllUsers();
                allUsers[username].currentRoom = currentRoom;
                allUsers[username].pendingRoomRequest = null;
                allUsers[username].rooms.push({
                    code: currentRoom,
                    joinedAt: new Date().toISOString()
                });
                await saveAllUsers();

                showLoading(false);
                closeNotifications();
                updateUI();
                showAlert('Request approved!', 'success');

            } catch (error) {
                showLoading(false);
                showAlert('Failed to approve request', 'error');
                console.error('Approve error:', error);
            }
        }

        async function denyJoinRequest(username) {
            showLoading(true);
            try {
                const requestIndex = roomData.joinRequests.findIndex(r => r.username === username);
                roomData.joinRequests.splice(requestIndex, 1);

                await saveRoomData();

                await loadAllUsers();
                allUsers[username].pendingRoomRequest = null;
                await saveAllUsers();

                showLoading(false);
                closeNotifications();
                updateUI();
                showAlert('Request denied', 'success');

            } catch (error) {
                showLoading(false);
                showAlert('Failed to deny request', 'error');
                console.error('Deny error:', error);
            }
        }

        // Room Actions
        async function preserveRoom() {
            if (!confirm('‚ö†Ô∏è WARNING: This will freeze the room forever. No new content, no deletions. CANNOT be undone.\n\nContinue?')) {
                return;
            }

            if (!confirm('Final warning. Room becomes read-only forever. Are you absolutely sure?')) {
                return;
            }

            showLoading(true);
            try {
                roomData.preserved = true;
                roomData.preservedAt = new Date().toISOString();
                roomData.preservedBy = currentUser.username;

                await saveRoomData();

                isPreserved = true;
                showLoading(false);
                showAlert('Room has been preserved', 'success');
                updateUI();

            } catch (error) {
                showLoading(false);
                showAlert('Failed to preserve room', 'error');
                console.error('Preserve error:', error);
            }
        }

        async function moveOn() {
            if (!confirm('Leave this room without notifying your partner?')) {
                return;
            }

            showLoading(true);
            try {
                const memberIndex = roomData.members.findIndex(m => m.username === currentUser.username);
                roomData.members.splice(memberIndex, 1);

                if (isAdmin && roomData.members.length > 0) {
                    roomData.admin = roomData.members[0].username;
                    roomData.adminHistory.push(roomData.members[0].username);
                }

                if (roomData.members.length === 0) {
                    await deleteRoom();
                } else {
                    await saveRoomData();
                }

                await loadAllUsers();
                allUsers[currentUser.username].currentRoom = null;
                await saveAllUsers();

                showLoading(false);
                showAlert('You have left the room', 'success');
                setTimeout(() => location.reload(), 1500);

            } catch (error) {
                showLoading(false);
                showAlert('Failed to leave room', 'error');
                console.error('Move on error:', error);
            }
        }

        async function initiateBreakup() {
            if (!confirm('‚ö†Ô∏è Request room deletion? Requires all members to confirm.')) {
                return;
            }

            showLoading(true);
            try {
                if (!roomData.breakupRequests) {
                    roomData.breakupRequests = {};
                }

                roomData.breakupRequests[currentUser.username] = new Date().toISOString();

                const allAgreed = roomData.members.every(m => roomData.breakupRequests[m.username]);

                if (allAgreed) {
                    await deleteRoom();
                    showLoading(false);
                    showAlert('Room deleted successfully', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    await saveRoomData();
                    showLoading(false);
                    updateBreakupStatus();
                    showAlert('Deletion request recorded. Waiting for others.', 'success');
                }

            } catch (error) {
                showLoading(false);
                showAlert('Failed to process request', 'error');
                console.error('Breakup error:', error);
            }
        }

        function updateBreakupStatus() {
            const container = document.getElementById('breakupStatus');
            if (!roomData.breakupRequests || Object.keys(roomData.breakupRequests).length === 0) {
                container.innerHTML = '';
                return;
            }

            const agreed = Object.keys(roomData.breakupRequests);
            const pending = roomData.members.filter(m => !roomData.breakupRequests[m.username]);

            container.innerHTML = `
                <div style="background: #fff3cd; padding: 1rem; border-radius: 8px;">
                    <strong>Deletion Status:</strong><br>
                    ‚úì Agreed: ${agreed.join(', ')}<br>
                    ‚è≥ Pending: ${pending.map(m => m.displayName).join(', ') || 'None'}
                </div>
            `;
        }

        async function deleteRoom() {
            const usePrivate = storageMode === 'private';
            const masterFileName = `${currentRoom}_master.txt`;
            const masterFile = await loadFromGitHub(masterFileName, usePrivate);

            if (masterFile) {
                for (const fileName of masterFile.content.files) {
                    const fileData = await loadFromGitHub(fileName, usePrivate);
                    if (fileData) {
                        await deleteFromGitHub(fileName, fileData.sha, usePrivate);
                    }
                }

                await deleteFromGitHub(masterFileName, masterFile.sha, usePrivate);
            }

            if (usePrivate) {
                await loadExportedRooms();
                delete exportedRooms[currentRoom];
                await saveExportedRooms();
            }

            await loadMasterRooms();
            delete masterRooms[currentRoom];
            await saveMasterRooms();

            await loadAllUsers();
            for (const member of roomData.members) {
                if (allUsers[member.username]) {
                    allUsers[member.username].currentRoom = null;
                }
            }
            await saveAllUsers();
        }

        // Content Functions
        function previewMemoryImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                if (file.size > 5 * 1024 * 1024) {
                    showAlert('Image must be less than 5MB', 'error');
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('memoryImagePreview');
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function previewNoteImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                if (file.size > 5 * 1024 * 1024) {
                    showAlert('Image must be less than 5MB', 'error');
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('noteImagePreview');
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        async function addMemory() {
            if (isPreserved) {
                showAlert('Room is preserved. No new content can be added.', 'error');
                return;
            }

            const title = document.getElementById('memoryTitle').value.trim();
            const description = document.getElementById('memoryDescription').value.trim();
            const date = document.getElementById('memoryDate').value;
            const imageInput = document.getElementById('memoryImage');

            if (!title || !description) {
                showAlert('Please fill in title and description', 'error');
                return;
            }

            showLoading(true);

            let imageData = null;
            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                imageData = await new Promise((resolve) => {
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(imageInput.files[0]);
                });
            }

            const memory = {
                id: `memory_${Date.now()}`,
                title,
                description,
                date: date || new Date().toISOString().split('T')[0],
                author: currentUser.displayName,
                authorUsername: currentUser.username,
                created: new Date().toISOString(),
                image: imageData
            };

            if (!roomData.memories) roomData.memories = [];
            roomData.memories.unshift(memory);
            
            await saveRoomData();

            document.getElementById('memoryTitle').value = '';
            document.getElementById('memoryDescription').value = '';
            document.getElementById('memoryDate').value = '';
            document.getElementById('memoryImage').value = '';
            document.getElementById('memoryImagePreview').classList.add('hidden');

            showLoading(false);
            updateUI();
            showAlert('Memory added successfully!', 'success');
        }

        async function addLink() {
            if (isPreserved) {
                showAlert('Room is preserved. No new content can be added.', 'error');
                return;
            }

            const title = document.getElementById('linkTitle').value.trim();
            const url = document.getElementById('linkUrl').value.trim();
            const description = document.getElementById('linkDescription').value.trim();

            if (!title || !url) {
                showAlert('Please fill in title and URL', 'error');
                return;
            }

            showLoading(true);

            const link = {
                id: `link_${Date.now()}`,
                title,
                url,
                description,
                author: currentUser.displayName,
                authorUsername: currentUser.username,
                created: new Date().toISOString()
            };

            if (!roomData.links) roomData.links = [];
            roomData.links.unshift(link);
            
            await saveRoomData();

            document.getElementById('linkTitle').value = '';
            document.getElementById('linkUrl').value = '';
            document.getElementById('linkDescription').value = '';

            showLoading(false);
            updateUI();
            showAlert('Link saved successfully!', 'success');
        }

        async function addNote() {
            if (isPreserved) {
                showAlert('Room is preserved. No new content can be added.', 'error');
                return;
            }

            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();
            const imageInput = document.getElementById('noteImage');

            if (!title || !content) {
                showAlert('Please fill in all fields', 'error');
                return;
            }

            showLoading(true);

            let imageData = null;
            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                imageData = await new Promise((resolve) => {
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(imageInput.files[0]);
                });
            }

            const note = {
                id: `note_${Date.now()}`,
                title,
                content,
                author: currentUser.displayName,
                authorUsername: currentUser.username,
                created: new Date().toISOString(),
                image: imageData
            };

            if (!roomData.notes) roomData.notes = [];
            roomData.notes.unshift(note);
            
            await saveRoomData();

            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            document.getElementById('noteImage').value = '';
            document.getElementById('noteImagePreview').classList.add('hidden');

            showLoading(false);
            updateUI();
            showAlert('Note saved successfully!', 'success');
        }

        async function sendMessage() {
            if (isPreserved) {
                showAlert('Room is preserved. No new messages.', 'error');
                return;
            }

            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content) return;

            const message = {
                id: `msg_${Date.now()}`,
                content,
                author: currentUser.displayName,
                authorUsername: currentUser.username,
                timestamp: new Date().toISOString(),
                type: 'message'
            };

            if (!roomData.messages) roomData.messages = [];
            roomData.messages.push(message);
            
            await saveRoomData();

            input.value = '';
            updateChatDisplay();
        }

        // UI Functions
        function showMainApp() {
            showLoading(false);
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainNav').classList.add('active');
            document.getElementById('mainContainer').classList.add('active');
            document.getElementById('userDisplayName').textContent = currentUser.displayName;
            document.getElementById('roomInfoDisplay').textContent = `Room: ${currentRoom}`;
            
            if (isAdmin) {
                document.getElementById('adminBadge').classList.remove('hidden');
                document.getElementById('notificationButton').classList.add('active');
                document.getElementById('storageManagement').classList.remove('hidden');
            }

            updateStorageBadges();
            updateUI();
            startPeriodicSync();
        }

        function updateStorageBadges() {
            const badge = document.getElementById('storageModeBadge');
            if (storageMode === 'private') {
                badge.textContent = 'Private';
                badge.className = 'storage-badge storage-private';
            } else {
                badge.textContent = 'Server';
                badge.className = 'storage-badge storage-server';
            }
        }

        function startPeriodicSync() {
            setInterval(async () => {
                if (currentRoom) {
                    try {
                        await loadRoomData();
                    } catch (error) {
                        console.error('Sync error:', error);
                    }
                }
            }, 30000);
        }

        function updateUI() {
            updateDashboard();
            updateMemoriesDisplay();
            updateLinksDisplay();
            updateNotesDisplay();
            updateChatDisplay();
            updateSettingsDisplay();
            updateNotificationBadge();
            updatePreservedState();
            updateStorageManagement();
        }

        function updateStorageManagement() {
            if (!isAdmin) return;

            document.getElementById('currentMode').textContent = storageMode === 'private' ? 'Private Storage' : 'Server Storage';
            
            if (storageMode === 'private') {
                document.getElementById('privateRepoInfo').classList.remove('hidden');
                document.getElementById('privateRepo').textContent = privateConfig ? privateConfig.githubRepo : 'Unknown';
                document.getElementById('switchToPrivateSection').classList.add('hidden');
                document.getElementById('switchToServerSection').classList.remove('hidden');
            } else {
                document.getElementById('privateRepoInfo').classList.add('hidden');
                document.getElementById('switchToPrivateSection').classList.remove('hidden');
                document.getElementById('switchToServerSection').classList.add('hidden');
            }
        }

        function updatePreservedState() {
            const cards = ['dashboardCard', 'memoriesCard', 'linksCard', 'notesCard', 'chatCard'];
            
            if (isPreserved) {
                cards.forEach(id => {
                    const card = document.getElementById(id);
                    if (card) {
                        card.classList.add('preserved');
                        if (!card.querySelector('.preserved-banner')) {
                            const banner = document.createElement('div');
                            banner.className = 'preserved-banner';
                            banner.textContent = 'üèõÔ∏è Preserved Room - Read Only';
                            card.insertBefore(banner, card.firstChild);
                        }
                    }
                });

                ['memoryForm', 'linkForm', 'noteForm', 'chatInputContainer'].forEach(id => {
                    const form = document.getElementById(id);
                    if (form) form.style.display = 'none';
                });

                ['addMemoryBtn', 'addNoteBtn', 'addLinkBtn', 'startChatBtn'].forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.disabled = true;
                });
            }
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const count = roomData.joinRequests?.length || 0;
            
            if (count > 0 && isAdmin) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function updateDashboard() {
            document.getElementById('memoriesCount').textContent = (roomData.memories || []).length;
            document.getElementById('notesCount').textContent = (roomData.notes || []).length;
            document.getElementById('linksCount').textContent = (roomData.links || []).length;
            document.getElementById('messagesCount').textContent = (roomData.messages || []).filter(m => m.type === 'message').length;

            updateRecentActivity();
        }

        function updateRecentActivity() {
            const container = document.getElementById('recentActivity');
            const activities = [];

            if (roomData.memories) {
                roomData.memories.slice(0, 3).forEach(m => {
                    activities.push({ text: `${m.author} added memory: "${m.title}"`, time: m.created });
                });
            }

            if (roomData.notes) {
                roomData.notes.slice(0, 3).forEach(n => {
                    activities.push({ text: `${n.author} wrote note: "${n.title}"`, time: n.created });
                });
            }

            if (roomData.links) {
                roomData.links.slice(0, 3).forEach(l => {
                    activities.push({ text: `${l.author} shared: "${l.title}"`, time: l.created });
                });
            }

            if (activities.length === 0) {
                container.innerHTML = '<p class="empty-state">No activity yet. Start creating memories!</p>';
                return;
            }

            activities.sort((a, b) => new Date(b.time) - new Date(a.time));

            container.innerHTML = activities.slice(0, 5).map(a => 
                `<p style="margin: 0.5rem 0;">üìå ${a.text}</p>`
            ).join('');
        }

        function updateMemoriesDisplay() {
            const container = document.getElementById('memoriesContainer');

            if (!roomData.memories || roomData.memories.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No memories yet</h3><p>Add your first special moment!</p></div>';
                return;
            }

            container.innerHTML = roomData.memories.map(m => `
                <div class="content-item">
                    <h4>${m.title}</h4>
                    <div class="meta">By ${m.author} on ${new Date(m.date).toLocaleDateString()}</div>
                    <p>${m.description}</p>
                    ${m.image ? `<img src="${m.image}" alt="${m.title}">` : ''}
                </div>
            `).join('');
        }

        function updateLinksDisplay() {
            const container = document.getElementById('linksContainer');

            if (!roomData.links || roomData.links.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No links yet</h3><p>Save your first shared link!</p></div>';
                return;
            }

            container.innerHTML = roomData.links.map(l => `
                <div class="content-item">
                    <h4><a href="${l.url}" target="_blank" style="color: var(--primary-pink);">${l.title}</a></h4>
                    <div class="meta">Shared by ${l.author} on ${new Date(l.created).toLocaleDateString()}</div>
                    ${l.description ? `<p>${l.description}</p>` : ''}
                </div>
            `).join('');
        }

        function updateNotesDisplay() {
            const container = document.getElementById('notesContainer');

            if (!roomData.notes || roomData.notes.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No notes yet</h3><p>Write your first sweet message!</p></div>';
                return;
            }

            container.innerHTML = roomData.notes.map(n => `
                <div class="content-item">
                    <h4>${n.title}</h4>
                    <div class="meta">From ${n.author} on ${new Date(n.created).toLocaleDateString()}</div>
                    <p>${n.content}</p>
                    ${n.image ? `<img src="${n.image}" alt="${n.title}">` : ''}
                </div>
            `).join('');
        }

        function updateChatDisplay() {
            const container = document.getElementById('chatContainer');

            if (!roomData.messages || roomData.messages.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No messages yet</h3><p>Start your conversation!</p></div>';
                return;
            }

            container.innerHTML = roomData.messages.map(msg => {
                if (msg.type === 'system') {
                    return `<div style="text-align: center; color: var(--text-light); margin: 1rem 0; font-style: italic;">${msg.content}</div>`;
                }

                const isSent = msg.authorUsername === currentUser.username;
                return `
                    <div class="chat-message ${isSent ? 'message-sent' : 'message-received'}">
                        <p>${msg.content}</p>
                        <small>${msg.author} - ${new Date(msg.timestamp).toLocaleTimeString()}</small>
                    </div>
                `;
            }).join('');

            container.scrollTop = container.scrollHeight;
        }

        function updateSettingsDisplay() {
            document.getElementById('settingsRoomCode').textContent = currentRoom;
            document.getElementById('settingsStorageMode').textContent = storageMode === 'private' ? 'Private Storage' : 'Server Storage';
            document.getElementById('settingsMemberCount').textContent = roomData.members?.length || 0;
            document.getElementById('settingsRole').textContent = isAdmin ? 'Admin' : 'Member';
            document.getElementById('settingsCreated').textContent = new Date(roomData.created).toLocaleString();
            
            updateBreakupStatus();
        }

        // Utility Functions
        function showAlert(message, type, containerId = null) {
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;

            if (containerId) {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                container.appendChild(alert);
            } else {
                const tempContainer = document.createElement('div');
                tempContainer.style.cssText = 'position: fixed; top: 100px; left: 50%; transform: translateX(-50%); z-index: 10000; max-width: 500px;';
                tempContainer.appendChild(alert);
                document.body.appendChild(tempContainer);
                setTimeout(() => tempContainer.remove(), 5000);
            }
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const targetPage = item.getAttribute('data-page');
                    showPage(targetPage);

                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                });
            });

            const msgInput = document.getElementById('messageInput');
            if (msgInput) {
                msgInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }

            const joinCodeInput = document.getElementById('joinRoomCode');
            if (joinCodeInput) {
                joinCodeInput.addEventListener('input', function(e) {
                    this.value = this.value.toUpperCase();
                });
            }

            const loginPwdInput = document.getElementById('loginPassword');
            if (loginPwdInput) {
                loginPwdInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        loginUser();
                    }
                });
            }

            const regUsernameInput = document.getElementById('regUsername');
            if (regUsernameInput) {
                regUsernameInput.addEventListener('input', function(e) {
                    this.value = this.value.toLowerCase();
                });
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) targetPage.classList.add('active');
        }
    </script>
</body>
</html>
