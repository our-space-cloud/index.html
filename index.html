<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Space</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5142562939066563"
     crossorigin="anonymous"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5142562939066563"
     crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-pink: #f8d7da;
            --secondary-lavender: #e7d3f4;
            --soft-peach: #ffeaa7;
            --mint-green: #d1f2eb;
            --soft-blue: #d4f1f4;
            --friendship-yellow: #ffd93d;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --white: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
            --error: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: linear-gradient(135deg, var(--primary-pink), var(--soft-blue));
            min-height: 100vh;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--text-light);
            border-top: 5px solid var(--primary-pink);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .help-button, .notification-button {
            position: fixed;
            top: 20px;
            width: 50px;
            height: 50px;
            background: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 20px var(--shadow);
            z-index: 1001;
            transition: all 0.3s ease;
        }

        .help-button {
            right: 20px;
        }

        .notification-button {
            right: 80px;
            display: none;
        }

        .notification-button.active {
            display: flex;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--error);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .help-button:hover, .notification-button:hover {
            transform: scale(1.1);
            background: var(--soft-peach);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 2rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: 25px;
            padding: 3rem;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .tutorial-step {
            display: none;
        }

        .tutorial-step.active {
            display: block;
        }

        .tutorial-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .auth-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .auth-card {
            background: var(--white);
            border-radius: 25px;
            padding: 3rem;
            text-align: center;
            box-shadow: 0 20px 60px var(--shadow);
            max-width: 600px;
            width: 100%;
        }

        .auth-card h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, var(--primary-pink), var(--secondary-lavender));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-pink);
        }

        .form-help {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .form-warning {
            background: #fff3cd;
            border: 1px solid var(--warning);
            color: #856404;
            padding: 0.75rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-size: 0.9rem;
        }

        .room-type-selector {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1.5rem 0;
        }

        .room-type-option {
            flex: 1;
            padding: 1.5rem;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .room-type-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px var(--shadow);
        }

        .room-type-option.selected {
            border-color: var(--primary-pink);
            background: linear-gradient(135deg, rgba(248, 215, 218, 0.2), rgba(231, 211, 244, 0.2));
        }

        .room-type-option.friendship.selected {
            border-color: var(--friendship-yellow);
            background: linear-gradient(135deg, rgba(255, 217, 61, 0.2), rgba(255, 234, 167, 0.2));
        }

        .room-type-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .btn {
            background: var(--secondary-lavender);
            color: var(--text-dark);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: var(--primary-pink);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn.primary {
            background: var(--primary-pink);
        }

        .btn.primary:hover {
            background: var(--secondary-lavender);
        }

        .btn.secondary {
            background: var(--soft-blue);
        }

        .btn.success {
            background: var(--success);
            color: white;
        }

        .btn.danger {
            background: var(--error);
            color: white;
        }

        .alert {
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            text-align: center;
        }

        .alert.error {
            background: #ffeaea;
            color: var(--error);
            border: 1px solid var(--error);
        }

        .alert.success {
            background: #eafaf1;
            color: var(--success);
            border: 1px solid var(--success);
        }

        nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px var(--shadow);
            display: none;
        }

        nav.active {
            display: block;
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-menu li {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-menu li:hover, .nav-menu li.active {
            background: var(--secondary-lavender);
            transform: translateY(-2px);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .room-info {
            background: var(--mint-green);
            padding: 0.5rem 1rem;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .room-info.friendship {
            background: var(--friendship-yellow);
        }

        .admin-badge {
            background: var(--warning);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 100px 2rem 2rem;
            min-height: 100vh;
            display: none;
        }

        .container.active {
            display: block;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .room-card {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px var(--shadow);
            cursor: pointer;
            transition: transform 0.3s ease;
            border: 3px solid transparent;
        }

        .room-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-pink);
        }

        .room-card.friendship {
            border-left: 5px solid var(--friendship-yellow);
        }

        .room-card.love {
            border-left: 5px solid var(--primary-pink);
        }

        .room-card.active-room {
            border-color: var(--success);
            box-shadow: 0 15px 40px rgba(39, 174, 96, 0.3);
        }

        .card {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem;
            margin: 1rem 0;
            box-shadow: 0 10px 30px var(--shadow);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card.preserved {
            background: linear-gradient(135deg, #fff5e6, #ffe6e6);
            border: 2px solid var(--warning);
        }

        .preserved-banner {
            background: var(--warning);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: bold;
        }

        .content-item {
            background: var(--white);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 5px 20px var(--shadow);
        }

        .content-item img {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 1rem;
        }

        .request-item {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 15px;
            margin: 1rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 20px var(--shadow);
        }

        .request-actions {
            display: flex;
            gap: 0.5rem;
        }

        .image-upload {
            border: 2px dashed var(--text-light);
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 1rem 0;
        }

        .image-upload:hover {
            border-color: var(--primary-pink);
            background: rgba(248, 215, 218, 0.1);
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin-top: 1rem;
        }

        .chat-container {
            height: 400px;
            background: var(--white);
            border-radius: 20px;
            padding: 1rem;
            margin-bottom: 1rem;
            overflow-y: auto;
            box-shadow: inset 0 2px 10px var(--shadow);
        }

        .chat-message {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 15px;
            max-width: 70%;
        }

        .message-sent {
            background: var(--primary-pink);
            margin-left: auto;
            text-align: right;
        }

        .message-received {
            background: var(--soft-blue);
        }

        .chat-input-container {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 25px;
            background: var(--white);
            box-shadow: 0 2px 10px var(--shadow);
            font-size: 1rem;
        }

        .settings-section {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem;
            margin: 1rem 0;
            box-shadow: 0 10px 30px var(--shadow);
        }

        .danger-zone {
            border: 2px solid var(--error);
            background: #ffeaea;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .nav-menu {
                flex-wrap: wrap;
                gap: 0.5rem;
                font-size: 0.9rem;
            }

            .nav-content {
                flex-direction: column;
                gap: 1rem;
            }

            .container {
                padding: 150px 1rem 1rem;
            }

            .request-item {
                flex-direction: column;
                gap: 1rem;
            }

            .rooms-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <div id="notificationButton" class="notification-button" onclick="showNotifications()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
        <div id="notificationBadge" class="notification-badge hidden">0</div>
    </div>

    <div id="helpButton" class="help-button" onclick="showTutorial()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
    </div>

    <!-- Tutorial Modal -->
    <div id="tutorialModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeTutorial()">√ó</button>
            
            <div class="tutorial-step active" data-step="1">
                <h2>Welcome to Our Space! üíï</h2>
                <p>A decentralized platform for couples and friends to share memories.</p>
                
                <h3>üîë How It Works</h3>
                <ul>
                    <li><strong>Your GitHub, Your Data:</strong> All data stored in YOUR personal GitHub repository</li>
                    <li><strong>No Central Server:</strong> Direct connection to GitHub</li>
                    <li><strong>Master File:</strong> Quick access to all your rooms</li>
                    <li><strong>Multiple Rooms:</strong> Create unlimited rooms for different people</li>
                    <li><strong>Room Types:</strong> Love üíï or Friendship üë´</li>
                </ul>

                <h3>‚ú® Features</h3>
                <ul>
                    <li>üì∏ Memories with photos</li>
                    <li>üîó Shared links</li>
                    <li>üìù Notes and messages</li>
                    <li>üí¨ Real-time chat (syncs every 1.5s)</li>
                    <li>üë• Join approval system</li>
                    <li>üèõÔ∏è Freeze rooms</li>
                    <li>üè∑Ô∏è Custom room names</li>
                </ul>
                
                <div class="tutorial-navigation">
                    <div></div>
                    <button class="btn primary" onclick="nextTutorialStep()">Next</button>
                </div>
            </div>

            <div class="tutorial-step" data-step="2">
                <h2>GitHub Setup üîß</h2>
                
                <h3>üìã First: Connect GitHub</h3>
                <ol>
                    <li><strong>Create Repository:</strong> Make a new private GitHub repository (e.g., "our-space-data")</li>
                    <li><strong>Generate PAT:</strong>
                        <ul>
                            <li>Go to github.com/settings/tokens</li>
                            <li>Click "Generate new token (classic)"</li>
                            <li>Select scopes: <code>repo</code> (all)</li>
                            <li>Generate and copy token</li>
                        </ul>
                    </li>
                    <li><strong>Enter Credentials:</strong> Provide repo name and token on first screen</li>
                </ol>

                <h3>üë§ Then: Choose Username</h3>
                <p>After GitHub connection is verified:</p>
                <ul>
                    <li>Enter your desired username</li>
                    <li>If username exists in the repo ‚Üí Login automatically</li>
                    <li>If username doesn't exist ‚Üí Account created automatically</li>
                    <li>Credentials saved locally for future logins</li>
                </ul>

                <h3>üîê Master File System</h3>
                <p>A <code>master_user_{username}.txt</code> file is automatically created containing:</p>
                <ul>
                    <li>All rooms you've created</li>
                    <li>All rooms you've joined</li>
                    <li>Quick access information</li>
                    <li>Synced across all your devices</li>
                </ul>

                <h3>‚ö†Ô∏è Important</h3>
                <ul>
                    <li>Keep your PAT secret - never share it</li>
                    <li>Use the SAME repo + PAT on all devices</li>
                    <li>Both partners can use same repo OR separate repos</li>
                </ul>
                
                <div class="tutorial-navigation">
                    <button class="btn" onclick="prevTutorialStep()">Back</button>
                    <button class="btn primary" onclick="nextTutorialStep()">Next</button>
                </div>
            </div>

            <div class="tutorial-step" data-step="3">
                <h2>Login Flow üîÑ</h2>
                
                <h3>üöÄ First Time Setup</h3>
                <ol>
                    <li><strong>Step 1:</strong> Enter GitHub repo and PAT</li>
                    <li><strong>Step 2:</strong> System verifies connection</li>
                    <li><strong>Step 3:</strong> Choose username</li>
                    <li><strong>Step 4:</strong> Master file created automatically</li>
                    <li><strong>Step 5:</strong> Ready to create/join rooms!</li>
                </ol>

                <h3>üîÑ Returning User</h3>
                <p>If you've used the app before on this browser:</p>
                <ul>
                    <li>GitHub credentials auto-loaded from browser</li>
                    <li>Just enter your username</li>
                    <li>Loads your master file</li>
                    <li>Shows all your rooms instantly</li>
                </ul>

                <h3>üíª Multiple Devices</h3>
                <p>To use on another device:</p>
                <ol>
                    <li>Enter same GitHub repo and PAT</li>
                    <li>Enter same username</li>
                    <li>All rooms sync automatically</li>
                </ol>

                <h3>üîó Shared vs Separate Repos</h3>
                <ul>
                    <li><strong>Shared Repo:</strong> Both partners use SAME repo/PAT ‚Üí instant sync</li>
                    <li><strong>Separate Repos:</strong> Each person uses OWN repo ‚Üí creator's repo stores room data</li>
                    <li>Room data always stored in creator's repository</li>
                </ul>
                
                <div class="tutorial-navigation">
                    <button class="btn" onclick="prevTutorialStep()">Back</button>
                    <button class="btn primary" onclick="nextTutorialStep()">Next</button>
                </div>
            </div>

            <div class="tutorial-step" data-step="4">
                <h2>Room Types & Management üè†</h2>
                
                <h3>üíï Love Rooms</h3>
                <p>For romantic relationships. Special features:</p>
                <ul>
                    <li>üíî <strong>Breakup:</strong> Request room deletion (all must agree)</li>
                    <li>üö∂ <strong>Move On:</strong> Leave silently (auto-deletes if all leave)</li>
                    <li>üèõÔ∏è <strong>Freeze:</strong> Make read-only forever</li>
                    <li>Pink/purple theme</li>
                </ul>

                <h3>üë´ Friendship Rooms</h3>
                <p>For friends and platonic relationships:</p>
                <ul>
                    <li>üö™ <strong>Leave:</strong> Exit room cleanly</li>
                    <li>üèõÔ∏è <strong>Freeze:</strong> Make read-only forever</li>
                    <li>No breakup mechanics</li>
                    <li>Yellow theme</li>
                </ul>

                <h3>üé® Room Naming</h3>
                <ul>
                    <li>Set custom name when creating room</li>
                    <li>Admin can rename anytime in settings</li>
                    <li>Room code remains same</li>
                    <li>Name shown in room list</li>
                </ul>

                <h3>üëë Admin Powers</h3>
                <ul>
                    <li>Approve/deny join requests</li>
                    <li>Rename room</li>
                    <li>Freeze room</li>
                    <li>Initiate breakup (love rooms)</li>
                    <li>If admin leaves, next member becomes admin</li>
                </ul>
                
                <div class="tutorial-navigation">
                    <button class="btn" onclick="prevTutorialStep()">Back</button>
                    <button class="btn primary" onclick="nextTutorialStep()">Next</button>
                </div>
            </div>

            <div class="tutorial-step" data-step="5">
                <h2>Multiple Rooms üóÇÔ∏è</h2>
                
                <h3>üìä Room Dashboard</h3>
                <p>Access from home page to see:</p>
                <ul>
                    <li>All rooms you've created</li>
                    <li>All rooms you've joined</li>
                    <li>Room type indicators (love/friendship)</li>
                    <li>Active room highlighted</li>
                    <li>Click any room to switch</li>
                </ul>

                <h3>üîÑ Room Switching</h3>
                <ol>
                    <li>Go to home page</li>
                    <li>Click on any room card</li>
                    <li>System loads that room's data</li>
                    <li>Navigation updates to show current room</li>
                    <li>All features work for active room</li>
                </ol>

                <h3>‚ûï Creating Multiple Rooms</h3>
                <ul>
                    <li>No limit on room creation</li>
                    <li>Each gets unique 6-character code</li>
                    <li>All tracked in your master file</li>
                    <li>Choose room type for each</li>
                    <li>Name each room uniquely</li>
                </ul>

                <h3>üìÅ File Structure</h3>
                <p>Your GitHub repo will contain:</p>
                <ul>
                    <li><code>master_user_{username}.txt</code> - Your room list</li>
                    <li><code>{ROOMCODE}_master.txt</code> - Room file index</li>
                    <li><code>{ROOMCODE}_1.txt, _2.txt...</code> - Room data</li>
                    <li>Separate files for each room you create</li>
                </ul>
                
                <div class="tutorial-navigation">
                    <button class="btn" onclick="prevTutorialStep()">Back</button>
                    <button class="btn primary" onclick="nextTutorialStep()">Next</button>
                </div>
            </div>

            <div class="tutorial-step" data-step="6">
                <h2>Important Reminders ‚ö†Ô∏è</h2>
                
                <h3>üîê Security</h3>
                <ul>
                    <li><strong>PAT Security:</strong> Never share your Personal Access Token</li>
                    <li><strong>Repo Privacy:</strong> Keep repository private</li>
                    <li><strong>Local Storage:</strong> GitHub credentials stored in browser only</li>
                    <li><strong>No Passwords:</strong> Authentication through GitHub PAT only</li>
                </ul>

                <h3>üíæ Data Management</h3>
                <ul>
                    <li><strong>Sync Speed:</strong> 1.5 second refresh for chat/updates</li>
                    <li><strong>Image Storage:</strong> Base64 embedded (5MB max per image)</li>
                    <li><strong>File Splitting:</strong> Auto-splits at 50MB per file</li>
                    <li><strong>Backups:</strong> Your GitHub repo IS your backup</li>
                </ul>

                <h3>üéØ Best Practices</h3>
                <ul>
                    <li>Use descriptive room names</li>
                    <li>Keep PAT secure and backed up</li>
                    <li>Regular GitHub repo backups</li>
                    <li>One browser = one set of credentials</li>
                    <li>Share room codes carefully</li>
                </ul>

                <h3>üêõ Troubleshooting</h3>
                <ul>
                    <li><strong>Can't load rooms:</strong> Check GitHub PAT permissions</li>
                    <li><strong>Slow sync:</strong> Large images may slow down loading</li>
                    <li><strong>Lost credentials:</strong> Re-enter repo + PAT to restore</li>
                    <li><strong>Room not found:</strong> Verify room code with partner</li>
                </ul>
                
                <div class="tutorial-navigation">
                    <button class="btn" onclick="prevTutorialStep()">Back</button>
                    <button class="btn primary" onclick="closeTutorial()">Get Started!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notificationsModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeNotifications()">√ó</button>
            <h2>Join Requests üîî</h2>
            <div id="notificationsContainer"></div>
        </div>
    </div>

    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <h1>Our Space üíï</h1>
            <p>Your personal GitHub-powered memory vault</p>
            
            <!-- GitHub Setup Form (First Step) -->
            <div id="githubSetupForm">
                <h2>Connect Your GitHub</h2>
                <p style="margin-bottom: 1rem; color: var(--text-light);">
                    First, let's connect to your GitHub repository where all your data will be stored.
                </p>
                
                <div class="form-group">
                    <label for="githubRepo">GitHub Repository *</label>
                    <input type="text" id="githubRepo" placeholder="username/repository-name">
                    <div class="form-help">Format: your-github-username/repo-name (e.g., john/our-space-data)</div>
                </div>
                
                <div class="form-group">
                    <label for="githubToken">Personal Access Token (PAT) *</label>
                    <input type="password" id="githubToken" placeholder="ghp_...">
                    <div class="form-help">Generate at github.com/settings/tokens with 'repo' permissions</div>
                </div>

                <div class="form-warning">
                    ‚ö†Ô∏è <strong>Important:</strong> These credentials are stored locally in your browser only. Keep your PAT secret!
                </div>
                
                <div id="setupAlert"></div>
                
                <button class="btn primary" onclick="verifyGitHubConnection()">Connect & Continue</button>
            </div>

            <!-- Login Form (After GitHub Connection) -->
            <div id="loginForm" class="hidden">
                <h2>Enter Username</h2>
                <p style="margin-bottom: 1rem; color: var(--text-light);">
                    GitHub connected! Now choose your username.
                </p>
                
                <div class="form-group">
                    <label for="loginUsername">Username</label>
                    <input type="text" id="loginUsername" placeholder="your_username" maxlength="30">
                    <div class="form-help">3-30 characters, lowercase letters, numbers, periods, underscores</div>
                </div>
                
                <div id="loginAlert"></div>
                
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn" onclick="backToGitHubSetup()">Back</button>
                    <button class="btn primary" onclick="checkUsername()">Continue</button>
                </div>
            </div>

            <!-- Room Dashboard (after login) -->
            <div id="roomDashboard" class="hidden">
                <h2>Your Rooms</h2>
                <p id="welcomeUser"></p>
                
                <div style="margin: 2rem 0;">
                    <button class="btn primary" style="width: 100%; margin-bottom: 1rem;" onclick="showCreateRoomForm()">+ Create New Room</button>
                    <button class="btn secondary" style="width: 100%;" onclick="showJoinRoomForm()">Join Existing Room</button>
                </div>

                <div id="roomsList" class="rooms-grid"></div>
            </div>

            <!-- Create Room Form -->
            <div id="createRoomForm" class="hidden">
                <h2>Create New Room</h2>
                
                <div class="form-group">
                    <label for="roomName">Room Name *</label>
                    <input type="text" id="roomName" placeholder="Give your room a name">
                    <div class="form-help">E.g., "Our Adventures", "Best Friends Forever"</div>
                </div>

                <div class="form-group">
                    <label>Room Type *</label>
                    <div class="room-type-selector">
                        <div class="room-type-option love selected" onclick="selectRoomType('love')">
                            <div class="room-type-icon">üíï</div>
                            <strong>Love Room</strong>
                            <p style="font-size: 0.85rem; margin-top: 0.5rem;">For couples</p>
                        </div>
                        <div class="room-type-option friendship" onclick="selectRoomType('friendship')">
                            <div class="room-type-icon">üë´</div>
                            <strong>Friendship</strong>
                            <p style="font-size: 0.85rem; margin-top: 0.5rem;">For friends</p>
                        </div>
                    </div>
                </div>
                
                <div id="createAlert"></div>
                
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn" onclick="backToRoomDashboard()">Back</button>
                    <button class="btn primary" onclick="createRoom()">Create Room</button>
                </div>
            </div>

            <!-- Join Room Form -->
            <div id="joinRoomForm" class="hidden">
                <h2>Join Existing Room</h2>
                
                <div class="form-group">
                    <label for="joinRoomCode">Room Code *</label>
                    <input type="text" id="joinRoomCode" placeholder="6-character code" maxlength="6">
                    <div class="form-help">Ask your friend/partner for the room code</div>
                </div>
                
                <div id="joinAlert"></div>
                
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn" onclick="backToRoomDashboard()">Back</button>
                    <button class="btn primary" onclick="requestJoinRoom()">Request to Join</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav id="mainNav">
        <div class="nav-content">
            <ul class="nav-menu">
                <li class="nav-item active" data-page="home" onclick="showPage('home')">üè† Rooms</li>
                <li class="nav-item" data-page="memories" onclick="showPage('memories')">üì∏ Memories</li>
                <li class="nav-item" data-page="links" onclick="showPage('links')">üîó Links</li>
                <li class="nav-item" data-page="notes" onclick="showPage('notes')">üìù Notes</li>
                <li class="nav-item" data-page="chat" onclick="showPage('chat')">üí¨ Chat</li>
                <li class="nav-item" data-page="settings" onclick="showPage('settings')">‚öôÔ∏è Settings</li>
            </ul>
            <div class="user-info">
                <div id="roomInfoDisplay" class="room-info"></div>
                <span id="adminBadge" class="admin-badge hidden">ADMIN</span>
                <span id="userDisplayName"></span>
                <button class="btn danger" style="padding: 0.5rem 1rem; font-size: 0.9rem;" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div id="mainContainer" class="container">
        <!-- Rooms Page -->
        <div id="home" class="page active">
            <div class="card">
                <h2>Your Rooms üè†</h2>
                <p>Switch between rooms or create new ones</p>
                <div style="margin-top: 1.5rem;">
                    <button class="btn primary" onclick="showCreateRoomFromDashboard()">+ Create New Room</button>
                    <button class="btn secondary" onclick="showJoinRoomFromDashboard()">Join Room</button>
                </div>
            </div>

            <div id="activeRoomCard" class="card hidden">
                <h3>Currently Active Room</h3>
                <div id="activeRoomInfo"></div>
            </div>

            <h3 style="margin-top: 2rem;">All Your Rooms</h3>
            <div id="allRoomsList" class="rooms-grid"></div>
        </div>

        <!-- Memories Page -->
        <div id="memories" class="page">
            <div class="card" id="memoriesCard">
                <h2>Our Memories üì∏</h2>
                
                <div id="memoryForm">
                    <div class="form-group">
                        <label for="memoryTitle">Memory Title</label>
                        <input type="text" id="memoryTitle" placeholder="Enter memory title">
                    </div>
                    
                    <div class="form-group">
                        <label for="memoryDescription">Description</label>
                        <textarea id="memoryDescription" placeholder="Describe this special moment..." rows="4"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="memoryDate">Date</label>
                        <input type="date" id="memoryDate">
                    </div>
                    
                    <div class="form-group">
                        <label>Add Photo (Optional)</label>
                        <div class="image-upload" onclick="document.getElementById('memoryImage').click()">
                            <p>üì∑ Click to upload a photo</p>
                            <p style="font-size: 0.9rem; color: var(--text-light);">Maximum 5MB</p>
                        </div>
                        <input type="file" id="memoryImage" accept="image/*" style="display: none;" onchange="previewMemoryImage(this)">
                        <img id="memoryImagePreview" class="image-preview hidden">
                    </div>
                    
                    <button class="btn primary" onclick="addMemory()">Add Memory</button>
                </div>
            </div>

            <div id="memoriesContainer"></div>
        </div>

        <!-- Links Page -->
        <div id="links" class="page">
            <div class="card" id="linksCard">
                <h2>Our Links üîó</h2>
                
                <div id="linkForm">
                    <div class="form-group">
                        <label for="linkTitle">Link Title</label>
                        <input type="text" id="linkTitle" placeholder="Enter link title">
                    </div>
                    
                    <div class="form-group">
                        <label for="linkUrl">URL</label>
                        <input type="url" id="linkUrl" placeholder="https://example.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="linkDescription">Description</label>
                        <textarea id="linkDescription" placeholder="Why is this link special?" rows="3"></textarea>
                    </div>
                    
                    <button class="btn primary" onclick="addLink()">Save Link</button>
                </div>
            </div>

            <div id="linksContainer"></div>
        </div>

        <!-- Notes Page -->
        <div id="notes" class="page">
            <div class="card" id="notesCard">
                <h2>Our Notes üìù</h2>
                
                <div id="noteForm">
                    <div class="form-group">
                        <label for="noteTitle">Note Title</label>
                        <input type="text" id="noteTitle" placeholder="Enter note title">
                    </div>
                    
                    <div class="form-group">
                        <label for="noteContent">Message</label>
                        <textarea id="noteContent" placeholder="Write your message..." rows="5"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Add Image (Optional)</label>
                        <div class="image-upload" onclick="document.getElementById('noteImage').click()">
                            <p>üì∑ Click to upload an image</p>
                            <p style="font-size: 0.9rem; color: var(--text-light);">Maximum 5MB</p>
                        </div>
                        <input type="file" id="noteImage" accept="image/*" style="display: none;" onchange="previewNoteImage(this)">
                        <img id="noteImagePreview" class="image-preview hidden">
                    </div>
                    
                    <button class="btn primary" onclick="addNote()">Save Note</button>
                </div>
            </div>

            <div id="notesContainer"></div>
        </div>

        <!-- Chat Page -->
        <div id="chat" class="page">
            <div class="card" id="chatCard">
                <h2>Private Chat üí¨</h2>
                <div class="chat-container" id="chatContainer"></div>
                
                <div class="chat-input-container" id="chatInputContainer">
                    <input type="text" class="chat-input" placeholder="Type your message..." id="messageInput">
                    <button class="btn primary" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settings" class="page">
            <div class="settings-section">
                <h2>Room Information ‚öôÔ∏è</h2>
                <div style="margin-top: 1rem;">
                    <p><strong>Room Name:</strong> <span id="settingsRoomName"></span></p>
                    <p><strong>Room Code:</strong> <span id="settingsRoomCode"></span></p>
                    <p><strong>Room Type:</strong> <span id="settingsRoomType"></span></p>
                    <p><strong>Members:</strong> <span id="settingsMemberCount"></span></p>
                    <p><strong>Your Role:</strong> <span id="settingsRole"></span></p>
                    <p><strong>Created:</strong> <span id="settingsCreated"></span></p>
                </div>
            </div>

            <!-- Room Name (Admin Only) -->
            <div id="roomNaming" class="settings-section hidden">
                <h2>üè∑Ô∏è Room Name (Admin Only)</h2>
                <p>Change the display name for this room.</p>
                
                <div class="form-group">
                    <label for="newRoomName">New Room Name</label>
                    <input type="text" id="newRoomName" placeholder="Enter new room name">
                </div>
                
                <button class="btn" onclick="renameRoom()" style="background: var(--secondary-lavender);">Rename Room</button>
            </div>

            <!-- Room Actions -->
            <div class="settings-section" id="loveRoomActions">
                <h2>‚ö†Ô∏è Room Actions</h2>
                
                <div style="margin: 1.5rem 0;">
                    <h3>üèõÔ∏è Freeze Room</h3>
                    <p>Make this room read-only forever. CANNOT be undone.</p>
                    <button class="btn" onclick="freezeRoom()" style="background: var(--warning); color: white; margin-top: 0.5rem;">Freeze Room</button>
                </div>

                <div style="margin: 1.5rem 0;" id="moveOnSection">
                    <h3>üö∂ Move On</h3>
                    <p>Leave room silently. If all leave, room auto-deletes.</p>
                    <button class="btn" onclick="moveOn()" style="background: var(--text-light); color: white; margin-top: 0.5rem;">Move On</button>
                </div>

                <div style="margin: 1.5rem 0;" id="breakupSection">
                    <h3>üíî Breakup (Delete Room)</h3>
                    <p>Permanently delete room. Requires all members to confirm. CANNOT be undone.</p>
                    <button class="btn danger" onclick="initiateBreakup()" style="margin-top: 0.5rem;">Request Deletion</button>
                    <div id="breakupStatus" style="margin-top: 1rem;"></div>
                </div>
            </div>

            <div class="settings-section hidden" id="friendshipRoomActions">
                <h2>‚ö†Ô∏è Room Actions</h2>
                
                <div style="margin: 1.5rem 0;">
                    <h3>üèõÔ∏è Freeze Room</h3>
                    <p>Make this room read-only forever. CANNOT be undone.</p>
                    <button class="btn" onclick="freezeRoom()" style="background: var(--warning); color: white; margin-top: 0.5rem;">Freeze Room</button>
                </div>

                <div style="margin: 1.5rem 0;">
                    <h3>üö™ Leave Room</h3>
                    <p>Exit this room. If all members leave, room will be deleted.</p>
                    <button class="btn" onclick="leaveRoom()" style="background: var(--text-light); color: white; margin-top: 0.5rem;">Leave Room</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        let config = {
            maxFileSize: 50 * 1024 * 1024,
            syncInterval: 1500 // 1.5 seconds
        };

        // Global state
        let currentUser = null;
        let currentRoom = null;
        let roomData = {};
        let currentTutorialStep = 1;
        let userGithubConfig = null;
        let userMasterData = {};
        let isAdmin = false;
        let isPreserved = false;
        let roomType = 'love';
        let selectedRoomType = 'love';
        let syncIntervalId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkIfNewUser();
            setupEventListeners();
        });

        function checkIfNewUser() {
            const hasVisited = localStorage.getItem('hasVisited');
            if (!hasVisited) {
                localStorage.setItem('hasVisited', 'true');
                setTimeout(() => showTutorial(), 500);
            }
        }

        // Tutorial functions
        function showTutorial() {
            document.getElementById('tutorialModal').classList.add('active');
            currentTutorialStep = 1;
            showTutorialStep(1);
        }

        function closeTutorial() {
            document.getElementById('tutorialModal').classList.remove('active');
        }

        function showTutorialStep(step) {
            document.querySelectorAll('.tutorial-step').forEach(s => s.classList.remove('active'));
            const stepEl = document.querySelector(`.tutorial-step[data-step="${step}"]`);
            if (stepEl) stepEl.classList.add('active');
        }

        function nextTutorialStep() {
            if (currentTutorialStep < 6) {
                currentTutorialStep++;
                showTutorialStep(currentTutorialStep);
            }
        }

        function prevTutorialStep() {
            if (currentTutorialStep > 1) {
                currentTutorialStep--;
                showTutorialStep(currentTutorialStep);
            }
        }

        // GitHub API Functions
        async function loadFromGitHub(fileName, githubConfig = null) {
            const cfg = githubConfig || userGithubConfig;
            if (!cfg) return null;

            try {
                const response = await fetch(`https://api.github.com/repos/${cfg.repo}/contents/${fileName}`, {
                    headers: {
                        'Authorization': `token ${cfg.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    return {
                        content: JSON.parse(decodeURIComponent(escape(atob(data.content)))),
                        sha: data.sha
                    };
                }
            } catch (error) {
                console.error(`Error loading ${fileName}:`, error);
            }
            return null;
        }

        async function saveToGitHub(fileName, content, sha = null, githubConfig = null) {
            const cfg = githubConfig || userGithubConfig;
            if (!cfg) throw new Error('No GitHub config');

            const encodedContent = btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2))));

            const body = {
                message: sha ? `Update ${fileName}` : `Create ${fileName}`,
                content: encodedContent
            };

            if (sha) body.sha = sha;

            const response = await fetch(`https://api.github.com/repos/${cfg.repo}/contents/${fileName}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${cfg.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || `Failed to save ${fileName}`);
            }

            return await response.json();
        }

        async function deleteFromGitHub(fileName, sha, githubConfig = null) {
            const cfg = githubConfig || userGithubConfig;
            if (!cfg) return;

            await fetch(`https://api.github.com/repos/${cfg.repo}/contents/${fileName}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `token ${cfg.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Delete ${fileName}`,
                    sha: sha
                })
            });
        }

        // User Management
        async function verifyGitHubConnection() {
            const repo = document.getElementById('githubRepo').value.trim();
            const token = document.getElementById('githubToken').value.trim();

            if (!repo || !token) {
                showAlert('Please fill in all fields', 'error', 'setupAlert');
                return;
            }

            if (!repo.includes('/')) {
                showAlert('Repository format should be: username/repo-name', 'error', 'setupAlert');
                return;
            }

            showLoading(true);

            try {
                // Test GitHub credentials
                const testResponse = await fetch(`https://api.github.com/repos/${repo}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!testResponse.ok) {
                    showLoading(false);
                    showAlert('Cannot access repository. Check your credentials and permissions.', 'error', 'setupAlert');
                    return;
                }

                // Save GitHub config temporarily (will be saved with username later)
                userGithubConfig = { repo, token };

                showLoading(false);
                showAlert('GitHub connection successful!', 'success', 'setupAlert');
                
                setTimeout(() => {
                    document.getElementById('githubSetupForm').classList.add('hidden');
                    document.getElementById('loginForm').classList.remove('hidden');
                }, 1000);

            } catch (error) {
                showLoading(false);
                showAlert('Failed to connect to GitHub. Please try again.', 'error', 'setupAlert');
                console.error('GitHub connection error:', error);
            }
        }

        function backToGitHubSetup() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('githubSetupForm').classList.remove('hidden');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginAlert').innerHTML = '';
        }

        async function checkUsername() {
            const username = document.getElementById('loginUsername').value.trim().toLowerCase();
            
            if (!username) {
                showAlert('Please enter a username', 'error', 'loginAlert');
                return;
            }

            if (username.length < 3 || username.length > 30) {
                showAlert('Username must be 3-30 characters', 'error', 'loginAlert');
                return;
            }

            if (!/^[a-z0-9._]+$/.test(username)) {
                showAlert('Username can only contain lowercase letters, numbers, periods, and underscores', 'error', 'loginAlert');
                return;
            }

            showLoading(true);

            try {
                // Check if user master file exists
                const fileName = `master_user_${username}.txt`;
                const fileData = await loadFromGitHub(fileName);
                
                if (fileData) {
                    // Existing user
                    currentUser = { username };
                    userMasterData = fileData.content;
                    
                    // Save GitHub config for this user
                    localStorage.setItem(`github_${username}`, JSON.stringify(userGithubConfig));
                    
                    showLoading(false);
                    showAlert('Welcome back!', 'success', 'loginAlert');
                    
                    setTimeout(() => {
                        showRoomDashboard();
                    }, 1000);
                } else {
                    // New user - create account
                    await createNewUser(username);
                }

            } catch (error) {
                showLoading(false);
                showAlert('Failed to load user data. Please try again.', 'error', 'loginAlert');
                console.error('Check username error:', error);
            }
        }

        async function createNewUser(username = null) {
            const user = username || document.getElementById('loginUsername').value.trim().toLowerCase();

            if (!user) return;

            showLoading(true);

            try {
                currentUser = { username: user };

                // Create master file
                userMasterData = {
                    username: user,
                    created: new Date().toISOString(),
                    rooms: []
                };

                await saveUserMasterFile();

                // Save GitHub config for this user
                localStorage.setItem(`github_${user}`, JSON.stringify(userGithubConfig));

                showLoading(false);
                showAlert('Account created successfully!', 'success', 'loginAlert');
                
                setTimeout(() => {
                    showRoomDashboard();
                }, 1500);

            } catch (error) {
                showLoading(false);
                showAlert('Failed to create account. Please try again.', 'error', 'loginAlert');
                console.error('Create user error:', error);
            }
        }

        async function loadUserMasterFile() {
            const fileName = `master_user_${currentUser.username}.txt`;
            const fileData = await loadFromGitHub(fileName);
            
            if (fileData) {
                userMasterData = fileData.content;
            } else {
                // Create new master file
                userMasterData = {
                    username: currentUser.username,
                    created: new Date().toISOString(),
                    rooms: []
                };
                await saveUserMasterFile();
            }
        }

        async function saveUserMasterFile() {
            const fileName = `master_user_${currentUser.username}.txt`;
            const fileData = await loadFromGitHub(fileName);
            await saveToGitHub(fileName, userMasterData, fileData?.sha);
        }

        function showRoomDashboard() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('githubSetupForm').classList.add('hidden');
            document.getElementById('roomDashboard').classList.remove('hidden');
            document.getElementById('welcomeUser').textContent = `Welcome, ${currentUser.username}!`;
            
            displayRoomsList();
        }

        function displayRoomsList() {
            const container = document.getElementById('roomsList');
            
            if (!userMasterData.rooms || userMasterData.rooms.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No rooms yet</h3><p>Create or join a room to get started!</p></div>';
                return;
            }

            container.innerHTML = userMasterData.rooms.map(room => `
                <div class="room-card ${room.type}" onclick="enterRoom('${room.code}')">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <h3>${room.name || 'Unnamed Room'}</h3>
                        <span style="font-size: 2rem;">${room.type === 'love' ? 'üíï' : 'üë´'}</span>
                    </div>
                    <p><strong>Code:</strong> ${room.code}</p>
                    <p><strong>Role:</strong> ${room.isAdmin ? 'Admin' : 'Member'}</p>
                    <p style="font-size: 0.85rem; color: var(--text-light);">Joined: ${new Date(room.joinedAt).toLocaleDateString()}</p>
                </div>
            `).join('');
        }

        function backToRoomDashboard() {
            document.getElementById('createRoomForm').classList.add('hidden');
            document.getElementById('joinRoomForm').classList.add('hidden');
            document.getElementById('roomDashboard').classList.remove('hidden');
        }

        function showCreateRoomForm() {
            document.getElementById('roomDashboard').classList.add('hidden');
            document.getElementById('createRoomForm').classList.remove('hidden');
            selectedRoomType = 'love';
        }

        function showJoinRoomForm() {
            document.getElementById('roomDashboard').classList.add('hidden');
            document.getElementById('joinRoomForm').classList.remove('hidden');
        }

        function showCreateRoomFromDashboard() {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainNav').classList.remove('active');
            document.getElementById('mainContainer').classList.remove('active');
            showCreateRoomForm();
        }

        function showJoinRoomFromDashboard() {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainNav').classList.remove('active');
            document.getElementById('mainContainer').classList.remove('active');
            showJoinRoomForm();
        }

        function selectRoomType(type) {
            selectedRoomType = type;
            document.querySelectorAll('.room-type-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector(`.room-type-option.${type}`).classList.add('selected');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                if (syncIntervalId) {
                    clearInterval(syncIntervalId);
                }
                currentUser = null;
                currentRoom = null;
                location.reload();
            }
        }

        // Room Management
        function generateRoomCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        async function createRoom() {
            const roomName = document.getElementById('roomName').value.trim();
            
            if (!roomName) {
                showAlert('Please enter a room name', 'error', 'createAlert');
                return;
            }

            showLoading(true);

            try {
                const roomCode = generateRoomCode();
                const masterFileName = `${roomCode}_master.txt`;
                const roomFileName = `${roomCode}_1.txt`;

                const roomMaster = {
                    code: roomCode,
                    files: [roomFileName],
                    created: new Date().toISOString()
                };

                roomData = {
                    code: roomCode,
                    name: roomName,
                    type: selectedRoomType,
                    admin: currentUser.username,
                    adminHistory: [currentUser.username],
                    created: new Date().toISOString(),
                    preserved: false,
                    breakupRequests: {},
                    members: [{
                        username: currentUser.username,
                        joinedAt: new Date().toISOString()
                    }],
                    joinRequests: [],
                    memories: [],
                    links: [],
                    notes: [],
                    messages: []
                };

                await saveToGitHub(masterFileName, roomMaster);
                await saveToGitHub(roomFileName, roomData);

                // Add to user's master file
                userMasterData.rooms.push({
                    code: roomCode,
                    name: roomName,
                    type: selectedRoomType,
                    isAdmin: true,
                    joinedAt: new Date().toISOString(),
                    githubRepo: userGithubConfig.repo
                });
                await saveUserMasterFile();

                currentRoom = roomCode;
                isAdmin = true;
                roomType = selectedRoomType;

                showAlert(`Room created! Code: ${roomCode}`, 'success', 'createAlert');
                
                setTimeout(() => {
                    showMainApp();
                }, 2000);

            } catch (error) {
                showLoading(false);
                showAlert('Failed to create room', 'error', 'createAlert');
                console.error('Create room error:', error);
            }
        }

        async function requestJoinRoom() {
            const roomCode = document.getElementById('joinRoomCode').value.trim().toUpperCase();

            if (!roomCode || roomCode.length !== 6) {
                showAlert('Please enter a valid 6-character room code', 'error', 'joinAlert');
                return;
            }

            showLoading(true);

            try {
                // Check if room exists in user's repos or need to search
                let roomFound = false;
                let roomGithubConfig = userGithubConfig;

                // Try to load from user's own repo first
                const masterFileName = `${roomCode}_master.txt`;
                let masterFile = await loadFromGitHub(masterFileName);

                if (!masterFile) {
                    // Room not in user's repo - they'll need to get it from room creator
                    showLoading(false);
                    showAlert('Room not found. Make sure your partner/friend shares their GitHub repo with you, or uses the same repo.', 'error', 'joinAlert');
                    return;
                }

                const roomFile = await loadFromGitHub(masterFile.content.files[0]);
                if (!roomFile) {
                    showLoading(false);
                    showAlert('Room data not accessible', 'error', 'joinAlert');
                    return;
                }

                const room = roomFile.content;

                if (room.members.find(m => m.username === currentUser.username)) {
                    showLoading(false);
                    showAlert('You are already a member of this room', 'error', 'joinAlert');
                    return;
                }

                if (room.joinRequests.find(r => r.username === currentUser.username)) {
                    showLoading(false);
                    showAlert('You already have a pending request', 'error', 'joinAlert');
                    return;
                }

                room.joinRequests.push({
                    username: currentUser.username,
                    requestedAt: new Date().toISOString()
                });

                await saveToGitHub(masterFile.content.files[0], room, roomFile.sha);

                showAlert('Join request sent! Please wait for admin approval.', 'success', 'joinAlert');
                
                setTimeout(() => {
                    backToRoomDashboard();
                }, 2000);

            } catch (error) {
                showLoading(false);
                showAlert('Failed to send join request', 'error', 'joinAlert');
                console.error('Join request error:', error);
            }
        }

        async function enterRoom(roomCode) {
            currentRoom = roomCode;
            const roomInfo = userMasterData.rooms.find(r => r.code === roomCode);
            
            if (roomInfo) {
                showLoading(true);
                await loadRoomData();
            }
        }

        async function loadRoomData() {
            try {
                const masterFileName = `${currentRoom}_master.txt`;
                const masterFile = await loadFromGitHub(masterFileName);

                if (!masterFile) {
                    showLoading(false);
                    showAlert('Room not found', 'error');
                    return;
                }

                let mergedData = {};
                for (const fileName of masterFile.content.files) {
                    const fileData = await loadFromGitHub(fileName);
                    if (fileData) {
                        mergedData = { ...mergedData, ...fileData.content };
                    }
                }

                roomData = mergedData;
                isAdmin = roomData.admin === currentUser.username;
                isPreserved = roomData.preserved || false;
                roomType = roomData.type || 'love';

                showMainApp();

            } catch (error) {
                showLoading(false);
                showAlert('Failed to load room data', 'error');
                console.error('Load room error:', error);
            }
        }

        async function saveRoomData() {
            if (!currentRoom || !roomData) return;

            try {
                const masterFileName = `${currentRoom}_master.txt`;
                const masterFile = await loadFromGitHub(masterFileName);

                if (!masterFile) return;

                const dataString = JSON.stringify(roomData);
                const dataSize = new Blob([dataString]).size;

                if (dataSize > config.maxFileSize) {
                    await splitRoomData(masterFile);
                } else {
                    const firstFile = masterFile.content.files[0];
                    const fileData = await loadFromGitHub(firstFile);
                    await saveToGitHub(firstFile, roomData, fileData?.sha);
                }

            } catch (error) {
                console.error('Save error:', error);
                showAlert('Failed to save data', 'error');
            }
        }

        async function splitRoomData(masterFile) {
            const baseData = {
                code: roomData.code,
                name: roomData.name,
                type: roomData.type,
                admin: roomData.admin,
                adminHistory: roomData.adminHistory,
                created: roomData.created,
                preserved: roomData.preserved,
                breakupRequests: roomData.breakupRequests,
                members: roomData.members,
                joinRequests: roomData.joinRequests
            };

            const files = [];
            let fileIndex = 1;

            const baseFileName = `${currentRoom}_${fileIndex}.txt`;
            const baseFile = await loadFromGitHub(baseFileName);
            await saveToGitHub(baseFileName, { ...baseData, memories: [], links: [], notes: [], messages: [] }, baseFile?.sha);
            files.push(baseFileName);
            fileIndex++;

            if (roomData.memories && roomData.memories.length > 0) {
                const memoriesFileName = `${currentRoom}_${fileIndex}.txt`;
                const memoriesFile = await loadFromGitHub(memoriesFileName);
                await saveToGitHub(memoriesFileName, { ...baseData, memories: roomData.memories, links: [], notes: [], messages: [] }, memoriesFile?.sha);
                files.push(memoriesFileName);
                fileIndex++;
            }

            if (roomData.notes && roomData.notes.length > 0) {
                const notesFileName = `${currentRoom}_${fileIndex}.txt`;
                const notesFile = await loadFromGitHub(notesFileName);
                await saveToGitHub(notesFileName, { ...baseData, memories: [], links: [], notes: roomData.notes, messages: [] }, notesFile?.sha);
                files.push(notesFileName);
                fileIndex++;
            }

            const miscFileName = `${currentRoom}_${fileIndex}.txt`;
            const miscFile = await loadFromGitHub(miscFileName);
            await saveToGitHub(miscFileName, { ...baseData, memories: [], links: roomData.links || [], notes: [], messages: roomData.messages || [] }, miscFile?.sha);
            files.push(miscFileName);

            masterFile.content.files = files;
            await saveToGitHub(`${currentRoom}_master.txt`, masterFile.content, masterFile.sha);
        }

        // Notification System
        function showNotifications() {
            if (!isAdmin) return;

            const modal = document.getElementById('notificationsModal');
            const container = document.getElementById('notificationsContainer');

            if (!roomData.joinRequests || roomData.joinRequests.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No pending requests</p></div>';
            } else {
                container.innerHTML = roomData.joinRequests.map(req => `
                    <div class="request-item">
                        <div>
                            <strong>@${req.username}</strong>
                            <br>
                            <small>Requested: ${new Date(req.requestedAt).toLocaleString()}</small>
                        </div>
                        <div class="request-actions">
                            <button class="btn success" onclick="approveJoinRequest('${req.username}')">Approve</button>
                            <button class="btn danger" onclick="denyJoinRequest('${req.username}')">Deny</button>
                        </div>
                    </div>
                `).join('');
            }

            modal.classList.add('active');
        }

        function closeNotifications() {
            document.getElementById('notificationsModal').classList.remove('active');
        }

        async function approveJoinRequest(username) {
            showLoading(true);
            try {
                const requestIndex = roomData.joinRequests.findIndex(r => r.username === username);
                const request = roomData.joinRequests[requestIndex];
                roomData.joinRequests.splice(requestIndex, 1);

                roomData.members.push({
                    username: username,
                    joinedAt: new Date().toISOString()
                });

                roomData.messages.push({
                    id: `msg_${Date.now()}`,
                    content: `${username} joined the room`,
                    author: 'system',
                    timestamp: new Date().toISOString(),
                    type: 'system'
                });

                await saveRoomData();

                showLoading(false);
                closeNotifications();
                updateUI();
                showAlert('Request approved!', 'success');

            } catch (error) {
                showLoading(false);
                showAlert('Failed to approve request', 'error');
                console.error('Approve error:', error);
            }
        }

        async function denyJoinRequest(username) {
            showLoading(true);
            try {
                const requestIndex = roomData.joinRequests.findIndex(r => r.username === username);
                roomData.joinRequests.splice(requestIndex, 1);

                await saveRoomData();

                showLoading(false);
                closeNotifications();
                updateUI();
                showAlert('Request denied', 'success');

            } catch (error) {
                showLoading(false);
                showAlert('Failed to deny request', 'error');
                console.error('Deny error:', error);
            }
        }

        // Room Actions
        async function renameRoom() {
            const newName = document.getElementById('newRoomName').value.trim();
            
            if (!newName) {
                showAlert('Please enter a room name', 'error');
                return;
            }

            showLoading(true);
            try {
                roomData.name = newName;
                await saveRoomData();

                // Update user's master file
                const roomInfo = userMasterData.rooms.find(r => r.code === currentRoom);
                if (roomInfo) {
                    roomInfo.name = newName;
                    await saveUserMasterFile();
                }

                showLoading(false);
                updateUI();
                showAlert('Room renamed successfully!', 'success');

            } catch (error) {
                showLoading(false);
                showAlert('Failed to rename room', 'error');
                console.error('Rename error:', error);
            }
        }

        async function freezeRoom() {
            if (!confirm('‚ö†Ô∏è WARNING: This will freeze the room forever. No new content, no deletions. CANNOT be undone.\n\nContinue?')) {
                return;
            }

            if (!confirm('Final warning. Room becomes read-only forever. Are you absolutely sure?')) {
                return;
            }

            showLoading(true);
            try {
                roomData.preserved = true;
                roomData.preservedAt = new Date().toISOString();
                roomData.preservedBy = currentUser.username;

                await saveRoomData();

                isPreserved = true;
                showLoading(false);
                showAlert('Room has been frozen', 'success');
                updateUI();

            } catch (error) {
                showLoading(false);
                showAlert('Failed to freeze room', 'error');
                console.error('Freeze error:', error);
            }
        }

        async function leaveRoom() {
            if (!confirm('Leave this room? If all members leave, the room will be deleted.')) {
                return;
            }

            showLoading(true);
            try {
                const memberIndex = roomData.members.findIndex(m => m.username === currentUser.username);
                roomData.members.splice(memberIndex, 1);

                if (isAdmin && roomData.members.length > 0) {
                    roomData.admin = roomData.members[0].username;
                    roomData.adminHistory.push(roomData.members[0].username);
                }

                if (roomData.members.length === 0) {
                    await deleteRoom();
                } else {
                    await saveRoomData();
                }

                // Remove from user's master file
                userMasterData.rooms = userMasterData.rooms.filter(r => r.code !== currentRoom);
                await saveUserMasterFile();

                showLoading(false);
                showAlert('You have left the room', 'success');
                setTimeout(() => location.reload(), 1500);

            } catch (error) {
                showLoading(false);
                showAlert('Failed to leave room', 'error');
                console.error('Leave error:', error);
            }
        }

        async function moveOn() {
            if (!confirm('Leave this room without notifying your partner?')) {
                return;
            }

            await leaveRoom();
        }

        async function initiateBreakup() {
            if (!confirm('‚ö†Ô∏è Request room deletion? Requires all members to confirm.')) {
                return;
            }

            showLoading(true);
            try {
                if (!roomData.breakupRequests) {
                    roomData.breakupRequests = {};
                }

                roomData.breakupRequests[currentUser.username] = new Date().toISOString();

                const allAgreed = roomData.members.every(m => roomData.breakupRequests[m.username]);

                if (allAgreed) {
                    await deleteRoom();
                    showLoading(false);
                    showAlert('Room deleted successfully', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    await saveRoomData();
                    showLoading(false);
                    updateBreakupStatus();
                    showAlert('Deletion request recorded. Waiting for others.', 'success');
                }

            } catch (error) {
                showLoading(false);
                showAlert('Failed to process request', 'error');
                console.error('Breakup error:', error);
            }
        }

        function updateBreakupStatus() {
            const container = document.getElementById('breakupStatus');
            if (!roomData.breakupRequests || Object.keys(roomData.breakupRequests).length === 0) {
                container.innerHTML = '';
                return;
            }

            const agreed = Object.keys(roomData.breakupRequests);
            const pending = roomData.members.filter(m => !roomData.breakupRequests[m.username]);

            container.innerHTML = `
                <div style="background: #fff3cd; padding: 1rem; border-radius: 8px;">
                    <strong>Deletion Status:</strong><br>
                    ‚úì Agreed: ${agreed.join(', ')}<br>
                    ‚è≥ Pending: ${pending.map(m => m.username).join(', ') || 'None'}
                </div>
            `;
        }

        async function deleteRoom() {
            const masterFileName = `${currentRoom}_master.txt`;
            const masterFile = await loadFromGitHub(masterFileName);

            if (masterFile) {
                for (const fileName of masterFile.content.files) {
                    const fileData = await loadFromGitHub(fileName);
                    if (fileData) {
                        await deleteFromGitHub(fileName, fileData.sha);
                    }
                }

                await deleteFromGitHub(masterFileName, masterFile.sha);
            }

            // Remove from all members' master files (if they share same repo)
            for (const member of roomData.members) {
                try {
                    const memberMasterFile = `master_user_${member.username}.txt`;
                    const memberData = await loadFromGitHub(memberMasterFile);
                    if (memberData) {
                        memberData.content.rooms = memberData.content.rooms.filter(r => r.code !== currentRoom);
                        await saveToGitHub(memberMasterFile, memberData.content, memberData.sha);
                    }
                } catch (error) {
                    console.log(`Could not update ${member.username}'s master file`);
                }
            }
        }

        // Content Functions
        function previewMemoryImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                if (file.size > 5 * 1024 * 1024) {
                    showAlert('Image must be less than 5MB', 'error');
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('memoryImagePreview');
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function previewNoteImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                if (file.size > 5 * 1024 * 1024) {
                    showAlert('Image must be less than 5MB', 'error');
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('noteImagePreview');
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        async function addMemory() {
            if (isPreserved) {
                showAlert('Room is frozen. No new content can be added.', 'error');
                return;
            }

            const title = document.getElementById('memoryTitle').value.trim();
            const description = document.getElementById('memoryDescription').value.trim();
            const date = document.getElementById('memoryDate').value;
            const imageInput = document.getElementById('memoryImage');

            if (!title || !description) {
                showAlert('Please fill in title and description', 'error');
                return;
            }

            showLoading(true);

            let imageData = null;
            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                imageData = await new Promise((resolve) => {
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(imageInput.files[0]);
                });
            }

            const memory = {
                id: `memory_${Date.now()}`,
                title,
                description,
                date: date || new Date().toISOString().split('T')[0],
                author: currentUser.username,
                created: new Date().toISOString(),
                image: imageData
            };

            if (!roomData.memories) roomData.memories = [];
            roomData.memories.unshift(memory);
            
            await saveRoomData();

            document.getElementById('memoryTitle').value = '';
            document.getElementById('memoryDescription').value = '';
            document.getElementById('memoryDate').value = '';
            document.getElementById('memoryImage').value = '';
            document.getElementById('memoryImagePreview').classList.add('hidden');

            showLoading(false);
            updateUI();
            showAlert('Memory added successfully!', 'success');
        }

        async function addLink() {
            if (isPreserved) {
                showAlert('Room is frozen. No new content can be added.', 'error');
                return;
            }

            const title = document.getElementById('linkTitle').value.trim();
            const url = document.getElementById('linkUrl').value.trim();
            const description = document.getElementById('linkDescription').value.trim();

            if (!title || !url) {
                showAlert('Please fill in title and URL', 'error');
                return;
            }

            showLoading(true);

            const link = {
                id: `link_${Date.now()}`,
                title,
                url,
                description,
                author: currentUser.username,
                created: new Date().toISOString()
            };

            if (!roomData.links) roomData.links = [];
            roomData.links.unshift(link);
            
            await saveRoomData();

            document.getElementById('linkTitle').value = '';
            document.getElementById('linkUrl').value = '';
            document.getElementById('linkDescription').value = '';

            showLoading(false);
            updateUI();
            showAlert('Link saved successfully!', 'success');
        }

        async function addNote() {
            if (isPreserved) {
                showAlert('Room is frozen. No new content can be added.', 'error');
                return;
            }

            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();
            const imageInput = document.getElementById('noteImage');

            if (!title || !content) {
                showAlert('Please fill in all fields', 'error');
                return;
            }

            showLoading(true);

            let imageData = null;
            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                imageData = await new Promise((resolve) => {
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(imageInput.files[0]);
                });
            }

            const note = {
                id: `note_${Date.now()}`,
                title,
                content,
                author: currentUser.username,
                created: new Date().toISOString(),
                image: imageData
            };

            if (!roomData.notes) roomData.notes = [];
            roomData.notes.unshift(note);
            
            await saveRoomData();

            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            document.getElementById('noteImage').value = '';
            document.getElementById('noteImagePreview').classList.add('hidden');

            showLoading(false);
            updateUI();
            showAlert('Note saved successfully!', 'success');
        }

        async function sendMessage() {
            if (isPreserved) {
                showAlert('Room is frozen. No new messages.', 'error');
                return;
            }

            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content) return;

            const message = {
                id: `msg_${Date.now()}`,
                content,
                author: currentUser.username,
                timestamp: new Date().toISOString(),
                type: 'message'
            };

            if (!roomData.messages) roomData.messages = [];
            roomData.messages.push(message);
            
            await saveRoomData();

            input.value = '';
            updateChatDisplay();
        }

        // UI Functions
        function showMainApp() {
            showLoading(false);
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainNav').classList.add('active');
            document.getElementById('mainContainer').classList.add('active');
            document.getElementById('userDisplayName').textContent = currentUser.username;
            document.getElementById('roomInfoDisplay').textContent = roomData.name || currentRoom;
            document.getElementById('roomInfoDisplay').className = `room-info ${roomType}`;
            
            if (isAdmin) {
                document.getElementById('adminBadge').classList.remove('hidden');
                document.getElementById('notificationButton').classList.add('active');
                document.getElementById('roomNaming').classList.remove('hidden');
            } else {
                document.getElementById('adminBadge').classList.add('hidden');
                document.getElementById('notificationButton').classList.remove('active');
                document.getElementById('roomNaming').classList.add('hidden');
            }

            // Show appropriate room actions based on type
            if (roomType === 'love') {
                document.getElementById('loveRoomActions').style.display = 'block';
                document.getElementById('friendshipRoomActions').classList.add('hidden');
            } else {
                document.getElementById('loveRoomActions').style.display = 'none';
                document.getElementById('friendshipRoomActions').classList.remove('hidden');
            }

            updateUI();
            startPeriodicSync();
        }

        function startPeriodicSync() {
            if (syncIntervalId) {
                clearInterval(syncIntervalId);
            }
            
            syncIntervalId = setInterval(async () => {
                if (currentRoom) {
                    try {
                        await loadRoomData();
                    } catch (error) {
                        console.error('Sync error:', error);
                    }
                }
            }, config.syncInterval);
        }

        function updateUI() {
            updateRoomsDashboard();
            updateMemoriesDisplay();
            updateLinksDisplay();
            updateNotesDisplay();
            updateChatDisplay();
            updateSettingsDisplay();
            updateNotificationBadge();
            updatePreservedState();
        }

        function updateRoomsDashboard() {
            const container = document.getElementById('allRoomsList');
            const activeCard = document.getElementById('activeRoomCard');
            const activeInfo = document.getElementById('activeRoomInfo');

            if (currentRoom && roomData) {
                activeCard.classList.remove('hidden');
                activeInfo.innerHTML = `
                    <h2>${roomData.name || 'Unnamed Room'} ${roomType === 'love' ? 'üíï' : 'üë´'}</h2>
                    <p><strong>Code:</strong> ${currentRoom}</p>
                    <p><strong>Members:</strong> ${roomData.members?.length || 0}</p>
                    <p><strong>Type:</strong> ${roomType === 'love' ? 'Love Room' : 'Friendship Room'}</p>
                `;
            }

            if (!userMasterData.rooms || userMasterData.rooms.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No rooms yet</h3><p>Create or join a room!</p></div>';
                return;
            }

            container.innerHTML = userMasterData.rooms.map(room => `
                <div class="room-card ${room.type} ${room.code === currentRoom ? 'active-room' : ''}" onclick="enterRoom('${room.code}')">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <h3>${room.name || 'Unnamed Room'}</h3>
                        <span style="font-size: 2rem;">${room.type === 'love' ? 'üíï' : 'üë´'}</span>
                    </div>
                    <p><strong>Code:</strong> ${room.code}</p>
                    <p><strong>Role:</strong> ${room.isAdmin ? 'Admin' : 'Member'}</p>
                    ${room.code === currentRoom ? '<p style="color: var(--success); font-weight: bold;">‚úì Active</p>' : ''}
                </div>
            `).join('');
        }

        function updatePreservedState() {
            const cards = ['memoriesCard', 'linksCard', 'notesCard', 'chatCard'];
            
            if (isPreserved) {
                cards.forEach(id => {
                    const card = document.getElementById(id);
                    if (card) {
                        card.classList.add('preserved');
                        if (!card.querySelector('.preserved-banner')) {
                            const banner = document.createElement('div');
                            banner.className = 'preserved-banner';
                            banner.textContent = 'üèõÔ∏è Frozen Room - Read Only';
                            card.insertBefore(banner, card.firstChild);
                        }
                    }
                });

                ['memoryForm', 'linkForm', 'noteForm', 'chatInputContainer'].forEach(id => {
                    const form = document.getElementById(id);
                    if (form) form.style.display = 'none';
                });
            }
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const count = roomData.joinRequests?.length || 0;
            
            if (count > 0 && isAdmin) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function updateMemoriesDisplay() {
            const container = document.getElementById('memoriesContainer');

            if (!roomData.memories || roomData.memories.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No memories yet</h3><p>Add your first special moment!</p></div>';
                return;
            }

            container.innerHTML = roomData.memories.map(m => `
                <div class="content-item">
                    <h4>${m.title}</h4>
                    <div style="color: var(--text-light); font-size: 0.9rem; margin: 0.5rem 0;">By @${m.author} on ${new Date(m.date).toLocaleDateString()}</div>
                    <p>${m.description}</p>
                    ${m.image ? `<img src="${m.image}" alt="${m.title}">` : ''}
                </div>
            `).join('');
        }

        function updateLinksDisplay() {
            const container = document.getElementById('linksContainer');

            if (!roomData.links || roomData.links.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No links yet</h3><p>Save your first shared link!</p></div>';
                return;
            }

            container.innerHTML = roomData.links.map(l => `
                <div class="content-item">
                    <h4><a href="${l.url}" target="_blank" style="color: var(--primary-pink);">${l.title}</a></h4>
                    <div style="color: var(--text-light); font-size: 0.9rem; margin: 0.5rem 0;">Shared by @${l.author} on ${new Date(l.created).toLocaleDateString()}</div>
                    ${l.description ? `<p>${l.description}</p>` : ''}
                </div>
            `).join('');
        }

        function updateNotesDisplay() {
            const container = document.getElementById('notesContainer');

            if (!roomData.notes || roomData.notes.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No notes yet</h3><p>Write your first message!</p></div>';
                return;
            }

            container.innerHTML = roomData.notes.map(n => `
                <div class="content-item">
                    <h4>${n.title}</h4>
                    <div style="color: var(--text-light); font-size: 0.9rem; margin: 0.5rem 0;">From @${n.author} on ${new Date(n.created).toLocaleDateString()}</div>
                    <p>${n.content}</p>
                    ${n.image ? `<img src="${n.image}" alt="${n.title}">` : ''}
                </div>
            `).join('');
        }

        function updateChatDisplay() {
            const container = document.getElementById('chatContainer');

            if (!roomData.messages || roomData.messages.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No messages yet</h3><p>Start your conversation!</p></div>';
                return;
            }

            container.innerHTML = roomData.messages.map(msg => {
                if (msg.type === 'system') {
                    return `<div style="text-align: center; color: var(--text-light); margin: 1rem 0; font-style: italic;">${msg.content}</div>`;
                }

                const isSent = msg.author === currentUser.username;
                return `
                    <div class="chat-message ${isSent ? 'message-sent' : 'message-received'}">
                        <p>${msg.content}</p>
                        <small>@${msg.author} - ${new Date(msg.timestamp).toLocaleTimeString()}</small>
                    </div>
                `;
            }).join('');

            container.scrollTop = container.scrollHeight;
        }

        function updateSettingsDisplay() {
            document.getElementById('settingsRoomName').textContent = roomData.name || 'Unnamed Room';
            document.getElementById('settingsRoomCode').textContent = currentRoom;
            document.getElementById('settingsRoomType').textContent = roomType === 'love' ? 'Love Room üíï' : 'Friendship Room üë´';
            document.getElementById('settingsMemberCount').textContent = roomData.members?.length || 0;
            document.getElementById('settingsRole').textContent = isAdmin ? 'Admin' : 'Member';
            document.getElementById('settingsCreated').textContent = new Date(roomData.created).toLocaleString();
            
            if (roomType === 'love') {
                updateBreakupStatus();
            }

            if (isAdmin) {
                document.getElementById('newRoomName').value = roomData.name || '';
            }
        }

        // Utility Functions
        function showAlert(message, type, containerId = null) {
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;

            if (containerId) {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                container.appendChild(alert);
            } else {
                const tempContainer = document.createElement('div');
                tempContainer.style.cssText = 'position: fixed; top: 100px; left: 50%; transform: translateX(-50%); z-index: 10000; max-width: 500px;';
                tempContainer.appendChild(alert);
                document.body.appendChild(tempContainer);
                setTimeout(() => tempContainer.remove(), 5000);
            }
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const targetPage = item.getAttribute('data-page');
                    showPage(targetPage);

                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                });
            });

            const msgInput = document.getElementById('messageInput');
            if (msgInput) {
                msgInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }

            const joinCodeInput = document.getElementById('joinRoomCode');
            if (joinCodeInput) {
                joinCodeInput.addEventListener('input', function(e) {
                    this.value = this.value.toUpperCase();
                });
            }

            const loginUsernameInput = document.getElementById('loginUsername');
            if (loginUsernameInput) {
                loginUsernameInput.addEventListener('input', function(e) {
                    this.value = this.value.toLowerCase();
                });
                loginUsernameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkUsername();
                    }
                });
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) targetPage.classList.add('active');
        }
    </script>
</body>
</html>
